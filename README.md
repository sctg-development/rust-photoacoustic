# Water Vapor Analyzer by Laser Photoacoustic Spectroscopy

## Project Objective

Develop a Rust program to analyze the concentration of water vapor in air using laser photoacoustic spectroscopy in a differential Helmholtz resonator. The goal is to process the sound signal to extract the amplitude of the fundamental component related to photoacoustic excitation.

## Physical Principle

- **Photoacoustic Spectroscopy**: A laser pulsed modulated to the cell's resonance frequency (typically 2 kHz). The laser beam interacts with the gas molecules, causing them to absorb energy and emit sound waves.
- passes through the cell containing the gas to be analyzed. The absorption of radiation by water vapor generates a pressure wave (sound) detected by microphones.
- **Differential Helmholtz Resonator**: Two microphones are placed:
  - Microphone A: in the gas flow excited by the laser.
  - Microphone B: in the non-excited gas flow (reference).
- **Differential Subtraction**: The useful signal is obtained by the difference: `Signal = Sound_A - Sound_B`. This amplifies the useful signal and reduces noise (see [Springer](https://link.springer.com/article/10.1007/s00216-019-01877-0), [Université de Reims](https://www.univ-reims.fr/gsma/equipes-de-recherche/physique-moleculaire-et-spectroscopie-ancien/spectrometrie-laser-et-applications/spectrometrie-photoacoustique,22274,37656.html)).

## Signal Processing

1. **Acquisition**: Synchronous recording of signals from both microphones.
2. **Preprocessing**: Digital filtering to eliminate out-of-band noise (band-pass filter around the excitation frequency).
3. **Subtraction**: Calculation of the differential signal (A-B).
4. **Fourier Transform**: Extraction of the amplitude of the fundamental component (laser excitation frequency).
5. **Display/Export**: Output of the amplitude of the useful signal, proportional to the water vapor concentration.

## Approach Advantages

- **Increased sensitivity** thanks to signal amplification in the resonator.
- **Noise reduction** by differential subtraction.
- **Compactness and robustness** of the instrument (see [Photoniques](https://www.photoniques.com/articles/photon/pdf/2011/04/photon201154p39.pdf)).

## Project Structure

```plaintext
rust-photoacoustic/
├── src/
│   ├── main.rs              # Application entry point
│   ├── acquisition/         # Audio signal acquisition module
│   │   └── mod.rs           # Microphone interface using CPAL
│   ├── preprocessing/       # Signal preprocessing module
│   │   ├── mod.rs           # Feature export
│   │   ├── filters.rs       # Digital filters implementation
│   │   └── differential.rs  # Differential signal calculation
│   ├── spectral/            # Spectral analysis module
│   │   ├── mod.rs           # Feature export
│   │   └── fft.rs           # FFT implementation using rustfft
│   └── visualization/       # Visualization module
│       ├── mod.rs           # Module exports
│       ├── api.rs           # REST API endpoints using Rocket
│       └── server.rs        # Web server configuration serving the SPA and API
├── web/                     # Frontend SPA
│   ├── src/                 # React components and hooks
│   ├── public/              # Static assets
│   ├── package.json         # NPM dependencies
│   └── vite.config.js       # Vite configuration
├── data/                    # Example data folder
├── examples/                # Usage examples
├── tests/                   # Integration tests
└── Cargo.toml               # Rust project configuration
```

## Technical Parameters

### Signal Acquisition

- **Sampling rate**: 48 kHz (configurable)
- **Resolution**: 16 bits
- **Channels**: 2 (microphone A and B)
- **Acquisition mode**: synchronous to preserve phase relationships

### Processing

- **Windowing**: Hann or Blackman-Harris (configurable)
- **FFT size**: 4096 points (configurable)
- **Band-pass filter**: 4th order Butterworth, centered on the excitation frequency
- **Averaging**: 10 spectra (configurable)

### The visualization module

The visualization module operates as an embedded web server built with the Rocket framework. It exposes a simple API, with OpenAPI documentation automatically generated by the `rocket_openapi` crate.

The server hosts a static single-page application (SPA) developed using Vite and React 19. This SPA presents the analysis results in a clear, user-friendly interface.

Key features:
- **API-first design:** Enables easy integration with other applications or systems, allowing users to access analysis results programmatically.
- **Modern frontend:** The SPA uses the [sctg vite react auth0 template](https://github.com/sctg-development/vite-react-heroui-auth0-template) for rapid development and a polished user experience.

This architecture ensures both interactive visualization and programmatic access to results.
  
### Used libraries
- `cpal`: Audio input/output library for Rust
- `rustfft`: Fast Fourier Transform library

### Evolution

- **Platform Upgrade**: The project is designed to evolve towards deployment on a Raspberry Pi. The next step is to upgrade the signal acquisition system to use two digital microphones connected via the I2S (Inter-IC Sound) protocol.
- **Why I2S?**: I2S enables high-fidelity, synchronized audio data transfer between the microphones and the Raspberry Pi, ensuring both channels are sampled simultaneously. This is crucial for accurate differential measurements, as it eliminates timing mismatches and external noise interference.
- **Expected Benefits**: Using I2S dual-microphone acquisition will provide cleaner, more reliable signals for both the measurement and reference channels, improving the accuracy and robustness of the water vapor analysis.
- **References**: For more details on I2S and its use with Raspberry Pi, see [Wikipedia](https://en.wikipedia.org/wiki/I2S) and this [I2S & Raspberry Pi article](https://protonestiot.medium.com/setting-up-i2s-soundcard-on-raspberry-pi-inmp441-microphone-f0c8fc859b2e).

## Available Options

- `--input-device`: Specify the audio input device to use (e.g. `hw:0,0` for ALSA)
- `--input-file`: Specify an audio file to analyze (e.g. `input.wav` must be PCM WAV)
- `--frequency`: Fundamental excitation frequency in Hz (default: 2 kHz)
- `--bandwidth`: Bandwidth of the band-pass filter in Hz (default: 100 Hz)
- `--output`: Output file for results (JSON)
- `--window-size`: Analysis window size in samples (default: 4096)
- `--averages`: Number of spectra to average (default: 10)

## References

- [Springer - Diode laser photoacoustic spectroscopy](https://link.springer.com/article/10.1007/s00216-019-01877-0)
- [Université de Reims - Photoacoustic Spectroscopy](https://www.univ-reims.fr/gsma/equipes-de-recherche/physique-moleculaire-et-spectroscopie-ancien/spectrometrie-laser-et-applications/spectrometrie-photoacoustique,22274,37656.html)
- [Photoniques - Photoacoustic Spectroscopy](https://www.photoniques.com/articles/photon/pdf/2011/04/photon201154p39.pdf)
- [Wikipedia - Photoacoustic spectroscopy](https://en.wikipedia.org/wiki/Photoacoustic_spectroscopy)
- Autogenerated OpenAPI documentation with `rocket_openapi` [sctdesk-api-server](https://github.com/sctg-development/sctgdesk-api-server/blob/2aecfe4d512d5fe5e6b05e123ed6a8b380a9a277/src/lib.rs#L117-222)
- SPA Static file serving [sctgdesk-api-server](https://github.com/sctg-development/sctgdesk-api-server/blob/main/src/lib.rs)
