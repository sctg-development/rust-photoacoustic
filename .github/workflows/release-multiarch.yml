# Copyright 2025 SCTG Development - Ronan LE MEILLAT
# This workflow builds multi-architecture static binaries for rust-photoacoustic
# and creates GitHub releases with all photoacoustic tools

name: Generate multi-arch Docker image and release linux binaries

permissions:
  id-token: write
  contents: write
  attestations: write
  packages: write

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      skip_dependency_builds:
        description: "Skip building static-deps and python-builder (use latest published versions)"
        required: false
        default: false
        type: boolean
      skip_static_deps:
        description: "Skip building static-deps image (use :latest)"
        required: false
        default: false
        type: boolean
      skip_python_builder:
        description: "Skip building python-builder image (use :latest)"
        required: false
        default: false
        type: boolean
      skip_app_build:
        description: "Skip building application images (use latest-amd64/arm64 from previous builds)"
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.12.12"
  PYTHON_SHORT_VERSION: "3.12"

# ========================================================
# WORKFLOW LOGIC DOCUMENTATION
# ========================================================
# This workflow can be executed in different ways by controlling skip inputs:
#
# SCENARIO 1: Full run (default, ~7h30)
#   - All builds execute: build_static_deps -> build_python_builder -> build_amd64/arm64 -> create_multiarch_manifest -> release
#
# SCENARIO 2: Skip static-deps only (if only minor changes)
#   - Skip: build_static_deps (uses sctg/rust-photoacoustic-static-deps:latest)
#   - Execute: build_python_builder -> build_amd64/arm64 -> create_multiarch_manifest -> release
#   - Set: skip_static_deps: true
#
# SCENARIO 3: Skip Python builder only (if only minor changes)
#   - Execute: build_static_deps -> skip python-builder (uses sctg/rust-photoacoustic-python-builder:latest)
#   - Execute: build_amd64/arm64 -> create_multiarch_manifest -> release
#   - Set: skip_python_builder: true
#
# SCENARIO 4: Skip all app builds (~1h, testing release stage only)
#   - Execute: build_static_deps -> build_python_builder -> SKIP build_amd64/arm64
#   - Execute: create_multiarch_manifest (uses latest-amd64 and latest-arm64 images from previous builds)
#   - Execute: release
#   - Set: skip_app_build: true
#
# SCENARIO 5: Quick run with all dependency skip (~20min, release stage only)
#   - Skip all dependency builds (uses :latest images)
#   - Skip all app builds (uses latest-amd64/arm64)
#   - Execute: create_multiarch_manifest -> release
#   - Set: skip_static_deps: true, skip_python_builder: true, skip_app_build: true

jobs:
  # Build non-static binaries for multiple platforms
  build_release_binaries:
    name: Build Release Binaries on ${{ matrix.os }} (${{ matrix.target }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false
          - os: macos-15-intel
            target: x86_64-apple-darwin
            cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            cross: true

    steps:
      # Set UTF-8 encoding for Windows to handle Unicode characters in Python scripts
      - name: Set UTF-8 encoding (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "LANG=en_US.UTF-8" >> $env:GITHUB_ENV
          echo "LC_ALL=en_US.UTF-8" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Clean runner for Docker builds
        if: matrix.os == 'ubuntu-latest'
        uses: sctg-development/clean-image-for-docker@v1
        with:
          remove-development-tools: "false"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 0

      # Debug submodules
      - name: Debug submodules
        shell: bash
        run: |
          echo "=== Git submodule status ==="
          git submodule status
          echo "=== .gitmodules content ==="
          cat .gitmodules || echo "No .gitmodules found"
          echo "=== Checking rust directory ==="
          ls -la rust/
          echo "=== Force submodule sync and update ==="
          git submodule sync --recursive
          git submodule update --init --recursive --force
          echo "=== Final submodule status ==="
          git submodule status

      # Install Rust toolchain
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.1
          targets: ${{ matrix.target }}
          components: rustfmt, clippy

      # Install dependencies for Linux
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config gcc-aarch64-linux-gnu libasound2-dev

      # Install LLVM and Clang (required for bindgen)
      - name: Install LLVM and Clang
        if: runner.os != 'macOS'
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "15"

      # Install Anaconda3 for Python support
      - name: Setup Anaconda3
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.12"
          channels: conda-forge,defaults
          channel-priority: true
          activate-environment: release-env
          use-mamba: false
          conda-solver: classic
          auto-activate-base: true

      # Configure Python environment variables for PyO3
      - name: Configure Python environment
        shell: bash -l {0}
        run: |
          # Activate conda environment
          conda activate release-env

          # Set environment variables
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "PYTHON_SYS_EXECUTABLE=$CONDA/envs/release-env/python.exe" >> $GITHUB_ENV
            echo "PYTHONPATH=$CONDA/envs/release-env/Lib/site-packages" >> $GITHUB_ENV
            echo "$CONDA/envs/release-env/Scripts" >> $GITHUB_PATH
            echo "$CONDA/envs/release-env" >> $GITHUB_PATH
          else
            echo "PYTHON_SYS_EXECUTABLE=$CONDA/envs/release-env/bin/python" >> $GITHUB_ENV
            echo "PYTHONPATH=$CONDA/envs/release-env/lib/python3.12/site-packages" >> $GITHUB_ENV
            echo "$CONDA/envs/release-env/bin" >> $GITHUB_PATH
            
            # Configure dynamic library path for macOS
            if [[ "${{ runner.os }}" == "macOS" ]]; then
              echo "DYLD_LIBRARY_PATH=$CONDA/envs/release-env/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
            fi
          fi

          # Install required Python packages
          conda install -n release-env numpy scipy matplotlib -y

      # Set release tag
      - name: Set release tag
        id: set_tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual workflow dispatch, use nightly tag with current date
            TAG="nightly.$(date +'%Y%m%d')"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Using nightly tag: $TAG"
          else
            # For release events, use the release tag
            TAG="${{ github.event.release.tag_name }}"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Using release tag: $TAG"
          fi

      # Cache Dependencies
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"
          key: rust-release-${{ matrix.os }}-${{ matrix.target }}

      - name: Create base configuration
        run: |
          cp rust/config.example.yaml rust/config.yaml

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "web/package-lock.json"

      - name: Install Node.js dependencies
        run: |
          cd web
          npm install && npm run build

      # Build release binaries
      - name: Build release binaries
        shell: bash -l {0}
        run: |
          cd rust
          # Activate conda environment
          conda activate release-env

          # Configure macOS dynamic library path if needed
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            export DYLD_LIBRARY_PATH="$CONDA/envs/release-env/lib:$DYLD_LIBRARY_PATH"
            echo "DYLD_LIBRARY_PATH set to: $DYLD_LIBRARY_PATH"
          fi

          # Build all binaries in release mode
          cargo build --release --target ${{ matrix.target }} --features python-driver

      # Package binaries with Python dependencies
      - name: Package binaries
        shell: bash -l {0}
        run: |
          cd rust
          conda activate release-env

          # Create package directory
          mkdir -p package/bin
          mkdir -p package/lib

          # Define file extensions based on OS
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            EXE_EXT=".exe"
            LIB_EXT=".dll"
            PYTHON_LIB_NAME="python312.dll"
          else
            EXE_EXT=""
            if [[ "${{ runner.os }}" == "macOS" ]]; then
              LIB_EXT=".dylib"
              PYTHON_LIB_NAME="libpython3.12.dylib"
            else
              LIB_EXT=".so"
              PYTHON_LIB_NAME="libpython3.12.so.1.0"
            fi
          fi

          # Copy all binaries
          for binary in rust_photoacoustic analyze_spectrum create_token debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen standalone; do
            if [ -f "target/${{ matrix.target }}/release/${binary}${EXE_EXT}" ]; then
              cp "target/${{ matrix.target }}/release/${binary}${EXE_EXT}" "package/bin/"
              echo "Packaged binary: ${binary}${EXE_EXT}"
            else
              echo "Binary not found: ${binary}${EXE_EXT}"
            fi
          done

          # Copy Python library
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp "$CONDA/envs/release-env/${PYTHON_LIB_NAME}" package/lib/ || echo "Python library not found"
            cp "$CONDA/envs/release-env/Library/bin/python312.dll" package/lib/ || echo "Python312.dll not found"
            cp "$CONDA/envs/release-env/Library/bin/zlib.dll" package/lib/ || echo "zlib.dll not found"
          else
            cp "$CONDA/envs/release-env/lib/${PYTHON_LIB_NAME}" package/lib/ || echo "Python library not found"
          fi

          # Create launch scripts for all binaries
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            # Windows batch scripts
            for binary in rust_photoacoustic analyze_spectrum create_token debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen standalone; do
              if [ -f "package/bin/${binary}.exe" ]; then
                # Create batch script directly with correct binary name
                echo "@echo off" > "package/${binary}.bat"
                echo "set SCRIPT_DIR=%~dp0" >> "package/${binary}.bat"
                echo "set PATH=%SCRIPT_DIR%lib;%PATH%" >> "package/${binary}.bat"
                echo "\"%SCRIPT_DIR%bin\\${binary}.exe\" %*" >> "package/${binary}.bat"
                echo "Created launch script: ${binary}.bat"
              fi
            done
          else
            # Unix shell scripts
            for binary in rust_photoacoustic analyze_spectrum create_token debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen standalone; do
              if [ -f "package/bin/${binary}" ]; then
                # Create shell script directly with correct binary name
                echo "#!/bin/bash" > "package/${binary}"
                echo 'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' >> "package/${binary}"
                echo 'if [[ "$OSTYPE" == "darwin"* ]]; then' >> "package/${binary}"
                echo '    export DYLD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${DYLD_LIBRARY_PATH}"' >> "package/${binary}"
                echo 'else' >> "package/${binary}"
                echo '    export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"' >> "package/${binary}"
                echo 'fi' >> "package/${binary}"
                echo "exec \"\${SCRIPT_DIR}/bin/${binary}\" \"\$@\"" >> "package/${binary}"
                chmod +x "package/${binary}"
                echo "Created launch script: ${binary}"
              fi
            done
          fi

          # Create README
          cat > package/README.md << 'EOF'
          # Rust Photoacoustic - Release Package

          This package contains the Rust Photoacoustic binaries with Python integration.

          ## Contents

          - `bin/`: Executable binaries
          - `lib/`: Required Python libraries  
          - Launch scripts for easy execution

          ## Available Tools

          - **rust_photoacoustic**: Main photoacoustic analysis server
          - **analyze_spectrum**: Spectrum analysis tool
          - **create_token**: JWT token generation utility
          - **debug_config**: Configuration debugging utility
          - **differential**: Differential signal processing
          - **filters**: Signal filtering utilities
          - **modbus_client**: Modbus communication client
          - **noise_generator**: Noise generation for testing
          - **pid_tuner**: PID controller tuning tool
          - **redis_viewer**: Redis data viewer
          - **rs256keygen**: RS256 key generation utility
          - **standalone**: Standalone analysis tool

          ## Usage

          ### On Windows:
          ```
          rust_photoacoustic.bat [options]
          pid_tuner.bat [options]
          analyze_spectrum.bat [options]
          # ... (other tools available with .bat extension)
          ```

          ### On macOS/Linux:
          ```
          # First remove quarantine attribute on macOS
          sudo xattr -r -d com.apple.quarantine *
          ./rust_photoacoustic [options]
          ./pid_tuner [options]
          ./analyze_spectrum [options]
          # ... (other tools available as executable scripts)
          ```

          ## Requirements

          - No additional Python installation required
          - All dependencies are included in this package
          EOF

          # Add build info to README
          echo "" >> package/README.md
          echo "## Version" >> package/README.md
          echo "" >> package/README.md
          echo "Built from: ${{ github.sha }}" >> package/README.md
          echo "Target: ${{ matrix.target }}" >> package/README.md
          echo "Build Date: $(date)" >> package/README.md

          # Create archive
          ARCHIVE_NAME="rust-photoacoustic-${{ steps.set_tag.outputs.tag }}-${{ matrix.target }}"
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            7z a "${ARCHIVE_NAME}.zip" package/*
            echo "ARCHIVE_PATH=${ARCHIVE_NAME}.zip" >> $GITHUB_ENV
          else
            tar -czf "${ARCHIVE_NAME}.tar.gz" -C package .
            echo "ARCHIVE_PATH=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_ENV
          fi

      # Upload artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-photoacoustic-${{ matrix.target }}
          path: rust/${{ env.ARCHIVE_PATH }}
          retention-days: 90

  # ========================================================
  # Static Dependencies Build (from build-static-deps.yml)
  # ========================================================
  build_static_deps:
    name: Build Static Dependencies
    runs-on: ubuntu-latest
    if: ${{ (inputs.skip_static_deps == false && inputs.skip_dependency_builds == false) || github.event_name == 'release' }}
    steps:
      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@v1
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64,linux/amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get version tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="nightly.$(date +'%Y%m%d')"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build and push static-deps image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./rust/docker/Dockerfile.deps
          platforms: linux/arm64,linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: true
          tags: |
            sctg/rust-photoacoustic-static-deps:latest
            sctg/rust-photoacoustic-static-deps:${{ steps.get_tag.outputs.tag }}
          labels: |
            org.opencontainers.image.title=rust-photoacoustic-static-deps
            org.opencontainers.image.description=Static dependencies for rust-photoacoustic (zlib, OpenSSL, librdkafka)
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ steps.get_tag.outputs.tag }}

  # ========================================================
  # Python Builder Build (from build-python-builder.yml)
  # ========================================================
  build_python_builder:
    name: Build Python Builder
    runs-on: ubuntu-latest
    if: ${{ (inputs.skip_python_builder == false && inputs.skip_dependency_builds == false) || github.event_name == 'release' }}
    needs: build_static_deps
    continue-on-error: ${{ inputs.skip_python_builder == true }}
    steps:
      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@v1
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64,linux/amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get version tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="nightly.$(date +'%Y%m%d')"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build and push python-builder image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./rust/docker/Dockerfile.python
          platforms: linux/arm64,linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: true
          tags: |
            sctg/rust-photoacoustic-python-builder:latest
            sctg/rust-photoacoustic-python-builder:${{ steps.get_tag.outputs.tag }}
          labels: |
            org.opencontainers.image.title=rust-photoacoustic-python-builder
            org.opencontainers.image.description=Python 3.12 statically compiled for rust-photoacoustic
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ steps.get_tag.outputs.tag }}

  # ========================================================
  # Get Version Tag
  # ========================================================
  get_version_tag:
    name: Get Version Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Get version tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="nightly.$(date +'%Y%m%d')"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "$TAG" > /tmp/tag.txt

      - name: Upload Tag for Next Jobs
        uses: actions/upload-artifact@v6
        with:
          name: tag-artifact
          path: /tmp/tag.txt

  # ========================================================
  # Build Final App AMD64 (from build-final-app.yml)
  # ========================================================
  build_amd64:
    name: Build Application (x86_64)
    runs-on: ubuntu-latest
    needs: [build_python_builder, get_version_tag]
    if: ${{ inputs.skip_app_build == false && (inputs.skip_python_builder == false || inputs.skip_dependency_builds == false) && (inputs.skip_static_deps == false || inputs.skip_dependency_builds == false) }}
    steps:
      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@docker-storage
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get version tag
        uses: actions/download-artifact@v7
        with:
          name: tag-artifact

      - name: Add TAG to output file
        shell: bash
        id: get_tag
        run: |
          TAG=$(cat tag.txt)
          echo "Using tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build and push x86_64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./rust/docker/Dockerfile.app
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: true
          tags: |
            sctg/rust-photoacoustic:latest-amd64
            sctg/rust-photoacoustic:${{ steps.get_tag.outputs.tag }}-amd64

  # ========================================================
  # Build Final App ARM64 (from build-final-app.yml)
  # ========================================================
  build_arm64:
    name: Build Application (arm64)
    needs: [build_python_builder, get_version_tag]
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_app_build == false && (inputs.skip_python_builder == false || inputs.skip_dependency_builds == false) && (inputs.skip_static_deps == false || inputs.skip_dependency_builds == false) }}
    steps:
      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@docker-storage
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up QEMU for arm64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get version tag
        uses: actions/download-artifact@v7
        with:
          name: tag-artifact

      - name: Add TAG to output file
        shell: bash
        id: get_tag
        run: |
          TAG=$(cat tag.txt)
          echo "Using tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build and push arm64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./rust/docker/Dockerfile.app
          platforms: linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: true
          tags: |
            sctg/rust-photoacoustic:latest-arm64
            sctg/rust-photoacoustic:${{ steps.get_tag.outputs.tag }}-arm64

      - name: Save Tag for Next Job
        uses: actions/upload-artifact@v6
        with:
          name: tag-artifact
          path: /tmp/tag.txt

  # ========================================================
  # Create Multi-Arch Manifest (from build-final-app.yml)
  # ========================================================
  create_multiarch_manifest:
    name: Create Multi-Architecture Manifest
    needs: [build_amd64, build_arm64, get_version_tag]
    runs-on: ubuntu-latest
    if: |
      always() &&
      (inputs.skip_app_build == false || 
       (inputs.skip_app_build == true && inputs.skip_python_builder == true && inputs.skip_static_deps == true))
    steps:
      - name: Download Tag from Previous Job
        uses: actions/download-artifact@v7
        with:
          name: tag-artifact

      - name: Add TAG to output file
        shell: bash
        id: get_tag
        run: |
          TAG=$(cat tag.txt)
          echo "Using tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Determine image tags to use
        id: image_tags
        shell: bash
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}

          # If app build was skipped, use latest tags
          if [ "${{ inputs.skip_app_build }}" = "true" ]; then
            echo "arm64_tag=latest-arm64" >> $GITHUB_OUTPUT
            echo "amd64_tag=latest-amd64" >> $GITHUB_OUTPUT
          else
            echo "arm64_tag=${TAG}-arm64" >> $GITHUB_OUTPUT
            echo "amd64_tag=${TAG}-amd64" >> $GITHUB_OUTPUT
          fi

      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@docker-storage
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Create and push multiarch image
        continue-on-error: true
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}
          ARM64_TAG=${{ steps.image_tags.outputs.arm64_tag }}
          AMD64_TAG=${{ steps.image_tags.outputs.amd64_tag }}

          # retrieve arm64 image and extract binaries
          docker pull --platform linux/arm64 sctg/rust-photoacoustic:${ARM64_TAG}
          # extract arm64 binaries
          docker create --platform linux/arm64 --name temp-container-arm64 sctg/rust-photoacoustic:${ARM64_TAG}
          mkdir -p /tmp/arm64-binaries/usr/local/bin /tmp/arm64-binaries/usr/local/lib
          for binary in create_token analyze_spectrum debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen rust_photoacoustic; do
            docker cp temp-container-arm64:/usr/local/bin/$binary /tmp/arm64-binaries/usr/local/bin/ || echo "$binary not found"
          done
          # extract python arm64 binaries and shared libs
          docker cp temp-container-arm64:/usr/local/lib/python${{ env.PYTHON_SHORT_VERSION }} /tmp/arm64-binaries/usr/local/lib/ || echo "python${{ env.PYTHON_SHORT_VERSION }} lib not found"
          docker cp temp-container-arm64:/usr/local/bin/python${{ env.PYTHON_SHORT_VERSION }} /tmp/arm64-binaries/usr/local/bin/ || echo "python${{ env.PYTHON_SHORT_VERSION }} binary not found"
          docker rm temp-container-arm64

          # retrieve amd64 image and extract binaries
          docker pull --platform linux/amd64 sctg/rust-photoacoustic:${AMD64_TAG}
          # extract amd64 binaries
          docker create --platform linux/amd64 --name temp-container-amd64 sctg/rust-photoacoustic:${AMD64_TAG}
          mkdir -p /tmp/amd64-binaries/usr/local/bin /tmp/amd64-binaries/usr/local/lib
          for binary in create_token analyze_spectrum debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen rust_photoacoustic; do
            docker cp temp-container-amd64:/usr/local/bin/$binary /tmp/amd64-binaries/usr/local/bin/ || echo "$binary not found"
          done
          # extract python amd64 binaries and shared libs
          docker cp temp-container-amd64:/usr/local/lib/python${{ env.PYTHON_SHORT_VERSION }} /tmp/amd64-binaries/usr/local/lib/ || echo "python${{ env.PYTHON_SHORT_VERSION }} lib not found"
          docker cp temp-container-amd64:/usr/local/bin/python${{ env.PYTHON_SHORT_VERSION }} /tmp/amd64-binaries/usr/local/bin/ || echo "python${{ env.PYTHON_SHORT_VERSION }} binary not found"
          docker rm temp-container-amd64

          # create multiarch image with both architectures' binaries
          CURRENT_DIR=$(pwd)
          cd /tmp
          docker buildx build --platform linux/amd64,linux/arm64 \
            --build-arg PYTHON_VERSION=${{ env.PYTHON_VERSION }} \
            --build-arg PYTHON_SHORT_VERSION=${{ env.PYTHON_SHORT_VERSION }} \
            -f ${CURRENT_DIR}/rust/docker/Dockerfile.multiarch \
            -t sctg/rust-photoacoustic:latest \
            -t sctg/rust-photoacoustic:${TAG} \
            --push .

      - name: Create release packages
        continue-on-error: true
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}
          mkdir -p /tmp/packages
          mkdir -p /tmp/amd64/lib
          # Create amd64 package
          for file in /tmp/amd64-binaries/usr/local/bin/*; do
            cp "$file" /tmp/amd64/
          done
          cp -av /tmp/amd64-binaries/usr/local/lib/python${{ env.PYTHON_SHORT_VERSION }} /tmp/amd64/lib/
          if [ -d "/tmp/amd64" ] && [ "$(ls -A /tmp/amd64)" ]; then
            cd /tmp/amd64
            tar czf /tmp/packages/rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz *
            echo "Created amd64 package"
          fi

          # Create arm64 package
          mkdir -p /tmp/arm64/lib
          for file in /tmp/arm64-binaries/usr/local/bin/*; do
            cp "$file" /tmp/arm64/
          done
          cp -av /tmp/arm64-binaries/usr/local/lib/python${{ env.PYTHON_SHORT_VERSION }} /tmp/arm64/lib/
          if [ -d "/tmp/arm64" ] && [ "$(ls -A /tmp/arm64)" ]; then
            cd /tmp/arm64
            tar czf /tmp/packages/rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz *
            echo "Created arm64 package"
          fi

      - name: Upload releases package artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-packages
          path: /tmp/packages/

      - name: Upload binaries artifact
        uses: actions/upload-artifact@v6
        with:
          name: final-binaries
          path: /tmp/*-binaries/

  # ========================================================
  # Release and Upload Static Binaries
  # ========================================================
  build_and_release_docker_static_image:
    permissions:
      id-token: write
      contents: write
      packages: write
      attestations: write
    name: Release Static Binaries from Artifacts
    runs-on: ubuntu-latest
    needs: [build_release_binaries, create_multiarch_manifest]
    if: always() && !failure()
    env:
      DOCKER_ARMHF_EXPERIMENTAL: off # Set to 'enabled' to enable armhf build
      INDIVIDUAL_STATIC_RELEASES: off # Set to 'enabled' to enable individual static releases
    steps:
      - name: Download Tag
        uses: actions/download-artifact@v7
        with:
          name: tag-artifact

      - name: Get Release Tag
        id: set_tag
        shell: bash
        run: |
          TAG=$(cat tag.txt)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"

      - name: Create release for nightly builds
        if: github.event_name == 'workflow_dispatch'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}
          echo "Creating nightly release: $TAG"
          gh release create "$TAG" --title "Nightly Build $TAG" --notes "Automated nightly build of rust-photoacoustic with multi-architecture static binaries." --prerelease

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts/

      - name: Extract binaries from artifacts
        shell: bash
        run: |
          # Extract final-binaries artifact which contains amd64-binaries and arm64-binaries
          if [ -d "artifacts/final-binaries" ]; then
            cp -r artifacts/final-binaries/* /tmp/
            echo "Extracted binaries from final-binaries artifact"
          fi

          # Display extracted structure
          echo "=== Extracted binaries structure ==="
          ls -la /tmp/*-binaries/ 2>/dev/null || echo "No binaries found"

      - name: Process amd64 binaries
        shell: bash
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}
          mkdir -p /tmp/amd64/

          if [ -d "/tmp/amd64-binaries/usr/local/bin" ]; then
            cd /tmp/amd64-binaries/usr/local/bin/
            # Copy all binaries
            for binary in *; do
              if [ -f "$binary" ]; then
                cp "$binary" "/tmp/amd64/${binary}_linux_amd64_static_${TAG}"
                echo "Processed: ${binary}_linux_amd64_static_${TAG}"
              fi
            done
          fi

          if [ -d "/tmp/amd64-binaries/usr/local/lib" ]; then
            cd /tmp/amd64-binaries/usr/local/lib/
            # Copy python library
            if [ -f "python${{ env.PYTHON_SHORT_VERSION }}" ] || [ -d "python${{ env.PYTHON_SHORT_VERSION }}" ]; then
              cp -r "python${{ env.PYTHON_SHORT_VERSION }}"* "/tmp/amd64/" 2>/dev/null || true
              echo "Processed: python libraries"
            fi
          fi

          echo "=== AMD64 binaries ready ==="
          ls -la /tmp/amd64/ || echo "No amd64 binaries"

      - name: Process arm64 binaries
        shell: bash
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}
          mkdir -p /tmp/arm64/

          if [ -d "/tmp/arm64-binaries/usr/local/bin" ]; then
            cd /tmp/arm64-binaries/usr/local/bin/
            # Copy all binaries
            for binary in *; do
              if [ -f "$binary" ]; then
                cp "$binary" "/tmp/arm64/${binary}_linux_arm64_static_${TAG}"
                echo "Processed: ${binary}_linux_arm64_static_${TAG}"
              fi
            done
          fi

          if [ -d "/tmp/arm64-binaries/usr/local/lib" ]; then
            cd /tmp/arm64-binaries/usr/local/lib/
            # Copy python library
            if [ -f "python${{ env.PYTHON_SHORT_VERSION }}" ] || [ -d "python${{ env.PYTHON_SHORT_VERSION }}" ]; then
              cp -r "python${{ env.PYTHON_SHORT_VERSION }}"* "/tmp/arm64/" 2>/dev/null || true
              echo "Processed: python libraries"
            fi
          fi

          echo "=== ARM64 binaries ready ==="
          ls -la /tmp/arm64/ || echo "No arm64 binaries"

      - name: Upload release artifacts from build_release_binaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}
          echo "Uploading release artifacts for tag: $TAG"

          for artifact_dir in artifacts/*/; do
            if [ -d "$artifact_dir" ] && [ "$(basename "$artifact_dir")" != "final-binaries" ] && [ "$(basename "$artifact_dir")" != "tag-artifact" ] && [ "$(basename "$artifact_dir")" != "release-packages" ]; then
              echo "Processing artifact directory: $artifact_dir"
              for file in "$artifact_dir"*; do
                if [ -f "$file" ]; then
                  echo "Uploading: $(basename $file)"
                  gh release upload --repo "$GITHUB_REPOSITORY" "$TAG" "$file" --clobber
                fi
              done
            fi
          done

      - name: Upload amd64 Release binaries
        if: ${{ env.INDIVIDUAL_STATIC_RELEASES == 'enabled' }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading amd64 binaries..."
          TAG=${{ steps.set_tag.outputs.tag }}

          # Upload individual static binaries
          ls -la /tmp/amd64/
          for binary in /tmp/amd64/*_linux_amd64_static_${TAG}; do
            if [ -f "$binary" ]; then
              echo "Uploading: $binary"
              gh release upload --repo "$GITHUB_REPOSITORY" ${TAG} "$binary" --clobber
            fi
          done

          # Upload static package
          if [ -f "/tmp/static-packages/amd64/rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz" ]; then
            echo "Uploading static package: rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz"
            gh release upload --repo "$GITHUB_REPOSITORY" ${TAG} "/tmp/static-packages/amd64/rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz" --clobber
          fi

      - name: Upload arm64 Release binaries
        if: ${{ env.INDIVIDUAL_STATIC_RELEASES == 'enabled' }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading arm64 binaries..."
          TAG=${{ steps.set_tag.outputs.tag }}

          # Upload individual static binaries
          ls -la /tmp/arm64/
          for binary in /tmp/arm64/*_linux_arm64_static_${TAG}; do
            if [ -f "$binary" ]; then
              echo "Uploading: $binary"
              gh release upload --repo "$GITHUB_REPOSITORY" ${TAG} "$binary" --clobber
            fi
          done

          # Upload static package
          if [ -f "/tmp/static-packages/arm64/rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz" ]; then
            echo "Uploading static package: rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz"
            gh release upload --repo "$GITHUB_REPOSITORY" ${TAG} "/tmp/static-packages/arm64/rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz" --clobber
          fi

      - name: Upload armhf Release binaries
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: ${{ env.DOCKER_ARMHF_EXPERIMENTAL == 'enabled' && env.INDIVIDUAL_STATIC_RELEASES == 'enabled' }}
        run: |
          echo "Uploading armhf binaries..."
          ls -la /tmp/armhf/
          for binary in /tmp/armhf/*_linux_armhf_static_${{ steps.set_tag.outputs.tag }}; do
            if [ -f "$binary" ]; then
              echo "Uploading: $binary"
              gh release upload --repo "$GITHUB_REPOSITORY" ${{ steps.set_tag.outputs.tag }} "$binary" --clobber
            fi
          done

      - name: Create static Linux packages
        continue-on-error: true
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}

          # Create amd64 static package
          if [ -d "/tmp/amd64" ] && [ "$(ls -A /tmp/amd64)" ]; then
            mkdir -p /tmp/static-package-amd64/bin
            mkdir -p /tmp/static-package-amd64/lib
            
            # Copy all binaries and remove architecture suffix for clean package
            cd /tmp/amd64/
            for file in *_linux_amd64_static_${TAG}; do
              if [ -f "$file" ]; then
                # Extract original binary name (remove _linux_amd64_static_TAG suffix)
                original_name=$(echo "$file" | sed "s/_linux_amd64_static_${TAG}//")
                if [[ "$original_name" == "libpython3.12.a" || "$original_name" == "python3.12" ]]; then
                  cp "$file" "/tmp/static-package-amd64/lib/${original_name}"
                # else
                #   cp "$file" "/tmp/static-package-amd64/bin/${original_name}"
                fi
                echo "Added to amd64 package: ${original_name}"
              fi
            done
            
            # Create launch scripts for all binaries
            for binary in rust_photoacoustic analyze_spectrum create_token debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen standalone; do
              if [ -f "/tmp/static-package-amd64/bin/${binary}" ]; then
                # Create launch script
                echo '#!/bin/bash' > "/tmp/static-package-amd64/${binary}"
                echo 'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' >> "/tmp/static-package-amd64/${binary}"
                echo 'export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"' >> "/tmp/static-package-amd64/${binary}"
                echo "exec \"\${SCRIPT_DIR}/bin/${binary}\" \"\$@\"" >> "/tmp/static-package-amd64/${binary}"
                chmod +x "/tmp/static-package-amd64/${binary}"
                echo "Created launch script: ${binary}"
              fi
            done
            
            # Create README for static package
            echo "# Rust Photoacoustic - Static Linux Package (x86_64)" > /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "This package contains statically linked Rust Photoacoustic binaries for Linux x86_64." >> /tmp/static-package-amd64/README.md
            echo "These binaries are self-contained and do not require external dependencies." >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "## Contents" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "- \`bin/\`: Statically linked executable binaries" >> /tmp/static-package-amd64/README.md
            echo "- \`lib/\`: Static Python libraries (if needed)" >> /tmp/static-package-amd64/README.md
            echo "- Launch scripts for easy execution" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "## Available Tools" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "- **rust_photoacoustic**: Main photoacoustic analysis server" >> /tmp/static-package-amd64/README.md
            echo "- **analyze_spectrum**: Spectrum analysis tool" >> /tmp/static-package-amd64/README.md
            echo "- **create_token**: JWT token generation utility" >> /tmp/static-package-amd64/README.md
            echo "- **debug_config**: Configuration debugging utility" >> /tmp/static-package-amd64/README.md
            echo "- **differential**: Differential signal processing" >> /tmp/static-package-amd64/README.md
            echo "- **filters**: Signal filtering utilities" >> /tmp/static-package-amd64/README.md
            echo "- **modbus_client**: Modbus communication client" >> /tmp/static-package-amd64/README.md
            echo "- **noise_generator**: Noise generation for testing" >> /tmp/static-package-amd64/README.md
            echo "- **pid_tuner**: PID controller tuning tool" >> /tmp/static-package-amd64/README.md
            echo "- **redis_viewer**: Redis data viewer" >> /tmp/static-package-amd64/README.md
            echo "- **rs256keygen**: RS256 key generation utility" >> /tmp/static-package-amd64/README.md
            echo "- **standalone**: Standalone analysis tool" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "## Usage" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "Execute any tool directly:" >> /tmp/static-package-amd64/README.md
            echo "./rust_photoacoustic [options]" >> /tmp/static-package-amd64/README.md
            echo "./pid_tuner [options]" >> /tmp/static-package-amd64/README.md
            echo "./analyze_spectrum [options]" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "## Requirements" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "- Linux x86_64 system" >> /tmp/static-package-amd64/README.md
            echo "- No additional dependencies required (statically linked)" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "## Version" >> /tmp/static-package-amd64/README.md
            echo "" >> /tmp/static-package-amd64/README.md
            echo "Built from: ${{ github.sha }}" >> /tmp/static-package-amd64/README.md
            echo "Target: x86_64-static-musl-linux-gnu" >> /tmp/static-package-amd64/README.md
            echo "Build Date: $(date)" >> /tmp/static-package-amd64/README.md
            
            # Create tar.gz package
            cd /tmp/static-package-amd64/
            tar -czf "../rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz" .
            echo "Created amd64 static package: rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz"
          fi

          # Create arm64 static package
          if [ -d "/tmp/arm64" ] && [ "$(ls -A /tmp/arm64)" ]; then
            mkdir -p /tmp/static-package-arm64/bin
            mkdir -p /tmp/static-package-arm64/lib
            
            # Copy all binaries and remove architecture suffix for clean package
            cd /tmp/arm64/
            for file in *_linux_arm64_static_${TAG}; do
              if [ -f "$file" ]; then
                # Extract original binary name (remove _linux_arm64_static_TAG suffix)
                original_name=$(echo "$file" | sed "s/_linux_arm64_static_${TAG}//")
                if [[ "$original_name" == "libpython3.12.a" || "$original_name" == "python3.12" ]]; then
                  cp "$file" "/tmp/static-package-arm64/lib/${original_name}"
                # else
                #   cp "$file" "/tmp/static-package-arm64/bin/${original_name}"
                fi
                echo "Added to arm64 package: ${original_name}"
              fi
            done
            
            # Create launch scripts for all binaries
            for binary in rust_photoacoustic analyze_spectrum create_token debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen standalone; do
              if [ -f "/tmp/static-package-arm64/bin/${binary}" ]; then
                # Create launch script
                echo '#!/bin/bash' > "/tmp/static-package-arm64/${binary}"
                echo 'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' >> "/tmp/static-package-arm64/${binary}"
                echo 'export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"' >> "/tmp/static-package-arm64/${binary}"
                echo "exec \"\${SCRIPT_DIR}/bin/${binary}\" \"\$@\"" >> "/tmp/static-package-arm64/${binary}"
                chmod +x "/tmp/static-package-arm64/${binary}"
                echo "Created launch script: ${binary}"
              fi
            done
            
            # Create README for static package
            echo "# Rust Photoacoustic - Static Linux Package (aarch64)" > /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "This package contains statically linked Rust Photoacoustic binaries for Linux aarch64." >> /tmp/static-package-arm64/README.md
            echo "These binaries are self-contained and do not require external dependencies." >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "## Contents" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "- \`bin/\`: Statically linked executable binaries" >> /tmp/static-package-arm64/README.md
            echo "- \`lib/\`: Static Python libraries (if needed)" >> /tmp/static-package-arm64/README.md
            echo "- Launch scripts for easy execution" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "## Available Tools" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "- **rust_photoacoustic**: Main photoacoustic analysis server" >> /tmp/static-package-arm64/README.md
            echo "- **analyze_spectrum**: Spectrum analysis tool" >> /tmp/static-package-arm64/README.md
            echo "- **create_token**: JWT token generation utility" >> /tmp/static-package-arm64/README.md
            echo "- **debug_config**: Configuration debugging utility" >> /tmp/static-package-arm64/README.md
            echo "- **differential**: Differential signal processing" >> /tmp/static-package-arm64/README.md
            echo "- **filters**: Signal filtering utilities" >> /tmp/static-package-arm64/README.md
            echo "- **modbus_client**: Modbus communication client" >> /tmp/static-package-arm64/README.md
            echo "- **noise_generator**: Noise generation for testing" >> /tmp/static-package-arm64/README.md
            echo "- **pid_tuner**: PID controller tuning tool" >> /tmp/static-package-arm64/README.md
            echo "- **redis_viewer**: Redis data viewer" >> /tmp/static-package-arm64/README.md
            echo "- **rs256keygen**: RS256 key generation utility" >> /tmp/static-package-arm64/README.md
            echo "- **standalone**: Standalone analysis tool" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "## Usage" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "Execute any tool directly:" >> /tmp/static-package-arm64/README.md
            echo "./rust_photoacoustic [options]" >> /tmp/static-package-arm64/README.md
            echo "./pid_tuner [options]" >> /tmp/static-package-arm64/README.md
            echo "./analyze_spectrum [options]" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "## Requirements" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "- Linux aarch64 system" >> /tmp/static-package-arm64/README.md
            echo "- No additional dependencies required (statically linked)" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "## Version" >> /tmp/static-package-arm64/README.md
            echo "" >> /tmp/static-package-arm64/README.md
            echo "Built from: ${{ github.sha }}" >> /tmp/static-package-arm64/README.md
            echo "Target: aarch64-static-musl-linux-gnu" >> /tmp/static-package-arm64/README.md
            echo "Build Date: $(date)" >> /tmp/static-package-arm64/README.md
            
            # Create tar.gz package
            cd /tmp/static-package-arm64/
            tar -czf "../rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz" .
            echo "Created arm64 static package: rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz"
          fi

      - name: Upload static Linux packages
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}
          echo "Uploading static Linux packages..."

          # Upload amd64 static package
          if [ -f "/tmp/rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz" ]; then
            echo "Uploading amd64 static package..."
            gh release upload --repo "$GITHUB_REPOSITORY" "$TAG" "/tmp/rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz" --clobber
          fi

          # Upload arm64 static package
          if [ -f "/tmp/rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz" ]; then
            echo "Uploading arm64 static package..."
            gh release upload --repo "$GITHUB_REPOSITORY" "$TAG" "/tmp/rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz" --clobber
          fi

      - name: Create attestation for release binaries
        uses: actions/attest-build-provenance@v1
        continue-on-error: true
        with:
          subject-path: |
            /tmp/amd64/*_linux_amd64_static_${{ steps.set_tag.outputs.tag }}
            /tmp/arm64/*_linux_arm64_static_${{ steps.set_tag.outputs.tag }}
            /tmp/armhf/*_linux_armhf_static_${{ steps.set_tag.outputs.tag }}

      - name: Generate release summary
        run: |
          echo "##  Multi-Architecture Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Released Binaries and Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Static Binaries | Static Package | Dynamic Binaries | Dynamic Package |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-----------------|----------------|------------------|-----------------|" >> $GITHUB_STEP_SUMMARY

          # AMD64 summary
          echo -n "| **Linux amd64** | " >> $GITHUB_STEP_SUMMARY
          ls /tmp/amd64/ 2>/dev/null | wc -l | tr -d '\n' >> $GITHUB_STEP_SUMMARY
          echo -n " individual | " >> $GITHUB_STEP_SUMMARY
          if [ -f "/tmp/rust-photoacoustic-"*"-x86_64-static-musl-linux-gnu.tar.gz" ]; then
            echo -n " tar.gz | " >> $GITHUB_STEP_SUMMARY
          else
            echo -n " No pkg | " >> $GITHUB_STEP_SUMMARY
          fi
          ls artifacts/rust-photoacoustic-x86_64-unknown-linux-gnu/ 2>/dev/null | wc -l | tr -d '\n' >> $GITHUB_STEP_SUMMARY
          echo -n " dynamic | " >> $GITHUB_STEP_SUMMARY
          if [ -f "artifacts/rust-photoacoustic-x86_64-unknown-linux-gnu.tar.gz" ]; then
            echo " tar.gz |" >> $GITHUB_STEP_SUMMARY
          else
            echo " No pkg |" >> $GITHUB_STEP_SUMMARY
          fi

          # ARM64 summary
          echo -n "| **Linux arm64** | " >> $GITHUB_STEP_SUMMARY
          ls /tmp/arm64/ 2>/dev/null | wc -l | tr -d '\n' >> $GITHUB_STEP_SUMMARY
          echo -n " individual | " >> $GITHUB_STEP_SUMMARY
          if [ -f "/tmp/rust-photoacoustic-"*"-aarch64-static-musl-linux-gnu.tar.gz" ]; then
            echo -n " tar.gz | " >> $GITHUB_STEP_SUMMARY
          else
            echo -n " No pkg | " >> $GITHUB_STEP_SUMMARY
          fi
          ls artifacts/rust-photoacoustic-aarch64-unknown-linux-gnu/ 2>/dev/null | wc -l | tr -d '\n' >> $GITHUB_STEP_SUMMARY
          echo -n " dynamic | " >> $GITHUB_STEP_SUMMARY
          if [ -f "artifacts/rust-photoacoustic-aarch64-unknown-linux-gnu.tar.gz" ]; then
            echo " tar.gz |" >> $GITHUB_STEP_SUMMARY
          else
            echo " No pkg |" >> $GITHUB_STEP_SUMMARY
          fi

          # Windows summary
          echo -n "| **Windows x64** | N/A | N/A | " >> $GITHUB_STEP_SUMMARY
          ls artifacts/rust-photoacoustic-x86_64-pc-windows-msvc/ 2>/dev/null | wc -l | tr -d '\n' >> $GITHUB_STEP_SUMMARY
          echo -n " dynamic | " >> $GITHUB_STEP_SUMMARY
          if [ -f "artifacts/rust-photoacoustic-x86_64-pc-windows-msvc.zip" ]; then
            echo " zip |" >> $GITHUB_STEP_SUMMARY
          else
            echo " No pkg |" >> $GITHUB_STEP_SUMMARY
          fi

          # macOS Intel summary
          echo -n "| **macOS Intel** | N/A | N/A | " >> $GITHUB_STEP_SUMMARY
          ls artifacts/rust-photoacoustic-x86_64-apple-darwin/ 2>/dev/null | wc -l | tr -d '\n' >> $GITHUB_STEP_SUMMARY
          echo -n " dynamic | " >> $GITHUB_STEP_SUMMARY
          if [ -f "artifacts/rust-photoacoustic-x86_64-apple-darwin.zip" ]; then
            echo " zip |" >> $GITHUB_STEP_SUMMARY
          else
            echo " No pkg |" >> $GITHUB_STEP_SUMMARY
          fi

          # macOS Apple Silicon summary
          echo -n "| **macOS Apple Silicon** | N/A | N/A | " >> $GITHUB_STEP_SUMMARY
          ls artifacts/rust-photoacoustic-aarch64-apple-darwin/ 2>/dev/null | wc -l | tr -d '\n' >> $GITHUB_STEP_SUMMARY
          echo -n " dynamic | " >> $GITHUB_STEP_SUMMARY
          if [ -f "artifacts/rust-photoacoustic-aarch64-apple-darwin.zip" ]; then
            echo " zip |" >> $GITHUB_STEP_SUMMARY
          else
            echo " No pkg |" >> $GITHUB_STEP_SUMMARY
          fi

          # ARMHF summary
          if [ "${{ env.DOCKER_ARMHF_EXPERIMENTAL }}" = "enabled" ]; then
            echo -n "| **Linux armhf** | " >> $GITHUB_STEP_SUMMARY
            ls /tmp/armhf/ 2>/dev/null | wc -l | tr -d '\n' >> $GITHUB_STEP_SUMMARY
            echo " individual | N/A | N/A | N/A |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Available Tools (All Packages)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **rust_photoacoustic**: Main photoacoustic analysis server" >> $GITHUB_STEP_SUMMARY
          echo "- **analyze_spectrum**: Spectrum analysis tool" >> $GITHUB_STEP_SUMMARY
          echo "- **create_token**: JWT token generation utility" >> $GITHUB_STEP_SUMMARY
          echo "- **debug_config**: Configuration debugging utility" >> $GITHUB_STEP_SUMMARY
          echo "- **differential**: Differential signal processing" >> $GITHUB_STEP_SUMMARY
          echo "- **filters**: Signal filtering utilities" >> $GITHUB_STEP_SUMMARY
          echo "- **modbus_client**: Modbus communication client" >> $GITHUB_STEP_SUMMARY
          echo "- **noise_generator**: Noise generation for testing" >> $GITHUB_STEP_SUMMARY
          echo "- **pid_tuner**: PID controller tuning tool" >> $GITHUB_STEP_SUMMARY
          echo "- **redis_viewer**: Redis data viewer" >> $GITHUB_STEP_SUMMARY
          echo "- **rs256keygen**: RS256 key generation utility" >> $GITHUB_STEP_SUMMARY
          echo "- **standalone**: Standalone analysis tool" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Package Types" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Static Linux packages (RECOMMENDED for servers):**" >> $GITHUB_STEP_SUMMARY
          echo "- \`bin/\`: All executable binaries (statically compiled with musl)" >> $GITHUB_STEP_SUMMARY
          echo "- \`lib/\`: Static Python libraries (if needed)" >> $GITHUB_STEP_SUMMARY
          echo "- Launch scripts for direct execution" >> $GITHUB_STEP_SUMMARY
          echo "- \`README.md\`: Complete documentation and usage guide" >> $GITHUB_STEP_SUMMARY
          echo "- **No dependencies**: Self-contained, works on any Linux (including Alpine)" >> $GITHUB_STEP_SUMMARY
          echo "- **Optimized**: Compiled for maximum performance and compatibility" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dynamic binary packages:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`bin/\`: Executable binaries (dynamically linked)" >> $GITHUB_STEP_SUMMARY
          echo "- \`lib/\`: Required Python libraries (.dylib/.dll/.so)" >> $GITHUB_STEP_SUMMARY
          echo "- Launch scripts for easy execution" >> $GITHUB_STEP_SUMMARY
          echo "- Platform-specific (Windows, macOS, Linux glibc)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Multi-architecture Docker image available at: \`sctg/rust-photoacoustic:${{ steps.set_tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**For production/server deployment (Linux):**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Download static package (self-contained)" >> $GITHUB_STEP_SUMMARY
          echo "wget 'https://github.com/${{ github.repository }}/releases/download/${{ steps.set_tag.outputs.tag }}/rust-photoacoustic-${{ steps.set_tag.outputs.tag }}-x86_64-static-musl-linux-gnu.tar.gz'" >> $GITHUB_STEP_SUMMARY
          echo "tar -xzf rust-photoacoustic-*.tar.gz && cd rust-photoacoustic-*/" >> $GITHUB_STEP_SUMMARY
          echo "./rust_photoacoustic --help" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**For development/local use:**" >> $GITHUB_STEP_SUMMARY
          echo "Download the appropriate dynamic package for your platform and extract." >> $GITHUB_STEP_SUMMARY

      - name: Update GitHub Release Notes
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}

          # Generate comprehensive release notes
          echo "##  Multi-Architecture Rust Photoacoustic Release" > release_notes.md
          echo "" >> release_notes.md
          echo "This release provides Rust Photoacoustic binaries for multiple platforms with both **static** and **dynamic** linking options." >> release_notes.md
          echo "" >> release_notes.md
          echo "###  Available Packages" >> release_notes.md
          echo "" >> release_notes.md
          echo "####  Static Linux Packages (RECOMMENDED for production)" >> release_notes.md
          echo "- \`rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz\` - Complete x86_64 static package" >> release_notes.md
          echo "- \`rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz\` - Complete aarch64 static package" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Features:**" >> release_notes.md
          echo "-  **Self-contained** - No external dependencies required" >> release_notes.md
          echo "-  **Universal compatibility** - Works on any Linux (including Alpine, Ubuntu, CentOS, etc.)" >> release_notes.md
          echo "-  **Easy deployment** - Extract and run anywhere" >> release_notes.md
          echo "-  **Production ready** - Optimized for performance and reliability" >> release_notes.md
          echo "" >> release_notes.md
          echo "####  Dynamic Packages (Platform-specific)" >> release_notes.md
          echo "- \`rust-photoacoustic-${TAG}-x86_64-pc-windows-msvc.zip\` - Windows x64 package" >> release_notes.md
          echo "- \`rust-photoacoustic-${TAG}-x86_64-apple-darwin.zip\` - macOS Intel package" >> release_notes.md
          echo "- \`rust-photoacoustic-${TAG}-aarch64-apple-darwin.zip\` - macOS Apple Silicon package" >> release_notes.md
          echo "- \`rust-photoacoustic-${TAG}-x86_64-unknown-linux-gnu.tar.gz\` - Linux x64 glibc package" >> release_notes.md
          echo "- \`rust-photoacoustic-${TAG}-aarch64-unknown-linux-gnu.tar.gz\` - Linux ARM64 glibc package" >> release_notes.md
          echo "" >> release_notes.md
          echo "###  Available Tools" >> release_notes.md
          echo "" >> release_notes.md
          echo "All packages include these Rust Photoacoustic tools:" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **rust_photoacoustic** - Main photoacoustic analysis server" >> release_notes.md
          echo "- **analyze_spectrum** - Spectrum analysis tool" >> release_notes.md
          echo "- **create_token** - JWT token generation utility" >> release_notes.md
          echo "- **debug_config** - Configuration debugging utility" >> release_notes.md
          echo "- **differential** - Differential signal processing" >> release_notes.md
          echo "- **filters** - Signal filtering utilities" >> release_notes.md
          echo "- **modbus_client** - Modbus communication client" >> release_notes.md
          echo "- **noise_generator** - Noise generation for testing" >> release_notes.md
          echo "- **pid_tuner** - PID controller tuning tool" >> release_notes.md
          echo "- **redis_viewer** - Redis data viewer" >> release_notes.md
          echo "- **rs256keygen** - RS256 key generation utility" >> release_notes.md
          echo "- **standalone** - Standalone analysis tool" >> release_notes.md
          echo "" >> release_notes.md
          echo "###  Quick Start" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### For Production/Server Deployment (Linux - Static)" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "# Download static package (recommended)" >> release_notes.md
          echo "wget https://github.com/${{ github.repository }}/releases/download/${TAG}/rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz" >> release_notes.md
          echo "" >> release_notes.md
          echo "# Extract and use" >> release_notes.md
          echo "tar -xzf rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz" >> release_notes.md
          echo "cd rust-photoacoustic-*/" >> release_notes.md
          echo "" >> release_notes.md
          echo "# Run any tool directly" >> release_notes.md
          echo "./rust_photoacoustic --help" >> release_notes.md
          echo "./pid_tuner --help" >> release_notes.md
          echo "./analyze_spectrum --help" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### For Development/Local Use (Dynamic)" >> release_notes.md
          echo "Download the appropriate package for your platform and extract. Run tools using the provided launch scripts." >> release_notes.md
          echo "" >> release_notes.md
          echo "###  Package Contents" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Static Packages (Linux):**" >> release_notes.md
          echo "- \`bin/\` - All statically linked binaries" >> release_notes.md
          echo "- \`lib/\` - Static Python libraries (if needed)" >> release_notes.md
          echo "- \`README.md\` - Complete documentation" >> release_notes.md
          echo "- Launch scripts for all tools" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Dynamic Packages (All Platforms):**" >> release_notes.md
          echo "- \`bin/\` - Platform-specific binaries" >> release_notes.md
          echo "- \`lib/\` - Required dynamic libraries" >> release_notes.md
          echo "- \`README.md\` - Platform-specific documentation" >> release_notes.md
          echo "- Platform-appropriate launch scripts" >> release_notes.md
          echo "" >> release_notes.md
          echo "###  Docker" >> release_notes.md
          echo "" >> release_notes.md
          echo "Multi-architecture Docker image: \`sctg/rust-photoacoustic:${TAG}\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "###  Performance & Compatibility" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **Static packages**: Completely portable, no dependency requirements" >> release_notes.md
          echo "- **Dynamic packages**: Smaller size but require platform-specific dependencies" >> release_notes.md
          echo "- **All packages**: Optimized release builds with maximum performance" >> release_notes.md
          echo "- **Universal**: Static packages work on any Linux distribution" >> release_notes.md
          echo "" >> release_notes.md
          echo "Choose the package type that best fits your deployment needs!" >> release_notes.md
          echo "" >> release_notes.md
          echo "Built from commit: ${{ github.sha }}" >> release_notes.md

          # Update the GitHub release with the comprehensive notes
          gh release edit "$TAG" --notes-file release_notes.md || echo "Failed to update release notes, continuing..."

          echo " Release notes updated with static package information"
