name: Rust CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build_web:
    name: Build and package web (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with: # fetch all submodules
          submodules: "recursive"
          fetch-depth: 0

      - name: Create base configuration
        run: |
          cp rust/config.example.yaml rust/config.yaml

      - name: Setup Node.js for web build
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "web/package-lock.json"

      - name: Install Node.js dependencies (web)
        run: |
          cd web
          npm ci --prefer-offline --no-audit

      - name: Build web
        run: |
          cd web
          npm run build

      - name: Upload web/dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web/dist

  build_and_test:
    name: Build and Test on ${{ matrix.os }} (${{ matrix.target }})
    runs-on: ${{ matrix.os }}

    needs: build_web
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false
          - os: macos-15-intel
            target: x86_64-apple-darwin
            cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            cross: false

    steps:
      # Set UTF-8 encoding for Windows to handle Unicode characters in Python scripts
      - name: Set UTF-8 encoding (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "LANG=en_US.UTF-8" >> $env:GITHUB_ENV
          echo "LC_ALL=en_US.UTF-8" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Clean runner for space (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: sctg-development/clean-image-for-docker@v1
        # Optional parameters
        with:
          remove-development-tools: "false"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - name: Remove Docker to save space (ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get remove -y docker docker-engine docker.io containerd runc
          sudo apt-get autoremove -y
          docker --version || echo "Docker removed"

      - uses: actions/checkout@v6
        with: # fetch all submodules
          submodules: "recursive"
          fetch-depth: 0

      # Debug submodules
      - name: Debug submodules
        shell: bash
        run: |
          echo "=== Git submodule status ==="
          git submodule status
          echo "=== .gitmodules content ==="
          cat .gitmodules
          echo "=== Checking rust directory ==="
          ls -la rust/
          echo "=== Force submodule sync and update ==="
          git submodule sync --recursive
          git submodule update --init --recursive --force
          echo "=== Final submodule status ==="
          git submodule status

      # Install Rust toolchain
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.1
          targets: ${{ matrix.target }}
          components: rustfmt, clippy

      # Install dependencies for Linux
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config libasound2-dev

      # Install CMake (required for rdkafka-sys on macOS)
      - name: Install CMake (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew uninstall cmake || true        # Remove any broken install
          brew install cmake
          cmake --version
          echo "CMAKE_POLICY_VERSION_MINIMUM=3.5" >> $GITHUB_ENV

      # Install LLVM and Clang (required for bindgen)
      - name: Install LLVM and Clang
        if: runner.os != 'macOS'
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "15"

      # Install Anaconda3 for Python support (needed for python-driver feature tests)
      - name: Setup Anaconda3
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.12"
          channels: conda-forge,defaults
          channel-priority: true
          activate-environment: test-env
          use-mamba: false
          conda-solver: classic
          auto-activate-base: true

      # Configure Python environment variables for PyO3
      - name: Configure Python environment
        shell: bash -l {0}
        run: |
          # Activate conda environment
          conda activate test-env

          # Set environment variables
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "PYTHON_SYS_EXECUTABLE=$CONDA/envs/test-env/python.exe" >> $GITHUB_ENV
            echo "PYTHONPATH=$CONDA/envs/test-env/Lib/site-packages" >> $GITHUB_ENV
            echo "$CONDA/envs/test-env/Scripts" >> $GITHUB_PATH
            echo "$CONDA/envs/test-env" >> $GITHUB_PATH
          else
            echo "PYTHON_SYS_EXECUTABLE=$CONDA/envs/test-env/bin/python" >> $GITHUB_ENV
            echo "PYTHONPATH=$CONDA/envs/test-env/lib/python3.12/site-packages" >> $GITHUB_ENV
            echo "$CONDA/envs/test-env/bin" >> $GITHUB_PATH
            
            # Configure dynamic library path for macOS
            if [[ "${{ runner.os }}" == "macOS" ]]; then
              echo "DYLD_LIBRARY_PATH=$CONDA/envs/test-env/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
            fi
          fi

          # Install required Python packages
          conda install -n test-env numpy scipy -y

      - name: Restore cache Rust dependencies and target
        uses: actions/cache/restore@v4
        id: cargo-cache
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            rust/target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}-rust-1.91.1
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-
            ${{ runner.os }}-cargo-

      - name: Restore Playwright browsers cache (Linux)
        if: runner.os == 'Linux'
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-${{ matrix.target }}-playwright-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-playwright-

      - name: Restore Playwright browsers cache (macOS)
        if: runner.os == 'macOS'
        uses: actions/cache/restore@v4
        with:
          path: ~/Library/Caches/ms-playwright
          key: ${{ runner.os }}-${{ matrix.target }}-playwright-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-playwright-

      - name: Restore Playwright browsers cache (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache/restore@v4
        with:
          path: ~/AppData/Local/ms-playwright
          key: ${{ runner.os }}-${{ matrix.target }}-playwright-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-playwright-

      - name: Run simple playwright-rust bin to download browsers
        shell: bash -l {0}
        run: |
          cd rust
          cargo run --bin playwright_github_connect || true

      - name: Create base configuration
        run: |
          cp rust/config.example.yaml rust/config.yaml

      - name: Download web artifact (dist)
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: ./artifact

      - name: Restore web/dist from artifact
        shell: bash
        run: |
          mkdir -p web
          # If artifact contains web/dist path, move it; otherwise try to copy files
          if [ -d artifact/web/dist ]; then
            rm -rf web/dist || true
            mv artifact/web/dist web/dist
          elif [ -d artifact/dist ]; then
            rm -rf web/dist || true
            mv artifact/dist web/dist
          else
            # fallback: copy all artifact contents into web/dist
            rm -rf web/dist || true
            mkdir -p web/dist
            cp -r artifact/* web/dist/ || true
          fi

      # Build project
      - name: Build
        run: |
          cd rust
          cargo build --target ${{ matrix.target }}
        shell: bash

      # Run tests (only on non-cross compilation targets)
      - name: Run tests
        id: run-tests
        if: matrix.cross == false
        shell: bash
        continue-on-error: true
        run: |
          cd rust
          # Run standard tests without python-driver feature
          cargo test --target ${{ matrix.target }} -- --skip test_acquisition_daemon \
              --skip test_python_node_scipy_bandpass_filter_single_channel \
              --skip test_python_node_scipy_bandpass_filter_dual_channel

      - name: Save Playwright browsers cache (Linux)
        if: always() && runner.os == 'Linux'
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-${{ matrix.target }}-playwright-${{ hashFiles('Cargo.lock') }}
    
      - name: Save Playwright browsers cache (macOS)
        if: always() && runner.os == 'macOS'
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: ~/Library/Caches/ms-playwright
          key: ${{ runner.os }}-${{ matrix.target }}-playwright-${{ hashFiles('Cargo.lock') }}

      - name: Save Playwright browsers cache (Windows)
        if: always() && runner.os == 'Windows'
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: ~/AppData/Local/ms-playwright
          key: ${{ runner.os }}-${{ matrix.target }}-playwright-${{ hashFiles('Cargo.lock') }}

      - name: Check if tests failed and fail the workflow
        if: always() && steps.run-tests.outcome == 'failure'
        run: |
          echo "Tests failed but Playwright cache was saved. Failing the workflow."
          exit 1
          
      # Run Python integration tests with python-driver feature
      - name: Run Python integration tests
        if: matrix.cross == false
        shell: bash -l {0}
        run: |
          cd rust
          # Activate conda environment
          conda activate test-env

          # Configure macOS dynamic library path if needed
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            export DYLD_LIBRARY_PATH="$CONDA/envs/test-env/lib:$DYLD_LIBRARY_PATH"
            echo "DYLD_LIBRARY_PATH set to: $DYLD_LIBRARY_PATH"
          fi

          # Verify Python setup
          echo "Python executable: $PYTHON_SYS_EXECUTABLE"
          python --version
          which python

          # List available Python libraries on macOS for debugging
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "Python library path: $CONDA/envs/test-env/lib"
            ls -la "$CONDA/envs/test-env/lib/" | grep -i python || echo "No python libraries found"
          fi

          # Run Python integration tests
          cargo test python_integration_tests --features python-driver --target ${{ matrix.target }}

          # Run doctests with python-driver feature
          echo "Running doctests..."
          cargo test --doc --features python-driver --target ${{ matrix.target }}

      - name: Cache Rust dependencies and target
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            rust/target
          key: ${{ steps.cargo-cache.outputs.cache-primary-key }}

      # Run specific tests with custom timeout
      - name: Run introspection tests
        if: matrix.cross == false
        run: |
          cd rust
          timeout_cmd=""
          if [[ "${{ runner.os }}" == "Linux" || "${{ runner.os }}" == "macOS" ]]; then
            timeout_cmd="timeout 30s"
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            # Using PowerShell timeout equivalent
            timeout_cmd="powershell -Command \"&{Start-Job -ScriptBlock {cargo test --test introspection_test -- --nocapture}; Start-Sleep -s 30; Get-Job | Stop-Job}\""
          fi

          if [[ -n "$timeout_cmd" ]]; then
            $timeout_cmd cargo test --test introspection_test -- --nocapture || echo "Test timed out but that's expected"
          else
            cargo test --test introspection_test -- --nocapture
          fi
        shell: bash

      - name: Clean target directory to save space (keep deps for coverage)
        continue-on-error: true
        if: matrix.os == 'ubuntu-latest' && matrix.cross == false
        run: |
          cd rust
          rm -rf target/ || true
          rm -rf /tmp/* || true
          rm -rf ~/.cargo/registry || true
          rm -rf ~/.cargo/git || true
          echo "Kept deps and incremental for coverage"

      - name: Restore target directory after cleaning for coverage
        id: restore-target-for-coverage
        if: matrix.os == 'ubuntu-latest' && matrix.cross == false
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-cargocoverage-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}-rust-1.91.1
          path: |
            rust/target
          restore-keys: |
            ${{ runner.os }}-cargocoverage-${{ matrix.target }}-
            ${{ runner.os }}-cargocoverage-

      # Run code coverage on Linux only
      - name: Run code coverage
        continue-on-error: true
        if: matrix.os == 'ubuntu-latest' && matrix.cross == false
        shell: bash
        run: |
          rm -rf /tmp/* || true
          echo "Disk space before code coverage:"
          df -h
          cd rust
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml --output-dir . -- --skip test_acquisition_daemon \
                                                      --skip test_python_node_scipy_bandpass_filter_single_channel \
                                                      --skip test_python_node_scipy_bandpass_filter_dual_channel
          ls -la cobertura.xml

      # Check space left (Ubuntu)
      - name: Check disk space (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Disk space after code coverage:"
          df -h

      # Upload coverage to Codecov
      - name: Upload coverage to Codecov
        continue-on-error: true
        if: matrix.os == 'ubuntu-latest' && matrix.cross == false
        uses: codecov/codecov-action@v5
        with:
          files: ./rust/cobertura.xml
          slug: sctg-development/rust-photoacoustic
          token: ${{ secrets.CODECOV_TOKEN }}
