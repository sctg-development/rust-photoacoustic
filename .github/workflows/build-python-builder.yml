# Copyright 2025 SCTG Development - Ronan LE MEILLAT
# This workflow builds Python 3.12 statically with all necessary dependencies
# and publishes it as sctg/rust-photoacoustic-python-builder on Docker Hub

name: Build Python Builder

permissions:
    id-token: write
    contents: read
    packages: write

on:
    workflow_dispatch:
    # Trigger after static-deps is built
    workflow_run:
        workflows: ["Build Static Dependencies"]
        types: [completed]

jobs:
    build_python_builder:
        name: Build Python Builder
        runs-on: ubuntu-latest
        if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
        steps:
            - name: Clean runner for Docker builds
              uses: sctg-development/clean-image-for-docker@v1
              with:
                  remove-development-tools: "true"
                  remove-browsers: "true"
                  remove-databases: "true"
                  remove-cloud-tools: "true"
                  show-top-packages: "true"

            - name: Check out the repo
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3
              with:
                  platforms: linux/arm64,linux/amd64

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Get version tag
              id: get_tag
              run: |
                  TAG=$(git describe --tags --always 2>/dev/null || echo "latest")
                  echo "tag=$TAG" >> $GITHUB_OUTPUT

            - name: Build and push python-builder image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./rust/docker/Dockerfile.python
                  platforms: linux/arm64,linux/amd64
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  push: true
                  tags: |
                      sctg/rust-photoacoustic-python-builder:latest
                      sctg/rust-photoacoustic-python-builder:${{ steps.get_tag.outputs.tag }}
                  labels: |
                      org.opencontainers.image.title=rust-photoacoustic-python-builder
                      org.opencontainers.image.description=Python 3.12 statically compiled for rust-photoacoustic
                      org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
                      org.opencontainers.image.version=${{ steps.get_tag.outputs.tag }}
