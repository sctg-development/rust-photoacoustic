# Copyright 2025 SCTG Development - Ronan LE MEILLAT
# This workflow builds the final rust-photoacoustic application
# Builds natively on ubuntu-latest (x86_64) and macos-latest (arm64)
# Then creates multi-architecture Docker image and extracts binaries

name: Build Final Application

permissions:
  id-token: write
  contents: write
  attestations: write
  packages: write

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      skip_builds:
        description: "Skip AMD64/ARM64 builds and only run multiarch manifest"
        required: false
        default: false
        type: boolean
  # Trigger after python-builder is built
  workflow_run:
    workflows: ["Build Python Builder"]
    types: [completed]

env:
  PYTHON_VERSION: "3.12.12"
  PYTHON_SHORT_VERSION: "3.12"
jobs:
  get_version_tag:
    name: Get Version Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Get version tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG=${{ github.event.release.tag_name }}
          else
            TAG=$(git rev-parse --short HEAD)
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "$TAG" > /tmp/tag.txt
      - name: Upload Tag for Next Jobs
        uses: actions/upload-artifact@v6
        with:
          name: tag-artifact
          path: /tmp/tag.txt

  build_amd64:
    name: Build Application (x86_64)
    runs-on: ubuntu-latest
    needs: get_version_tag
    if: (github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run') && !inputs.skip_builds
    steps:
      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@docker-storage
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get version tag
        uses: actions/download-artifact@v7
        with:
          name: tag-artifact
      - name: Add TAG to output file
        shell: bash
        id: get_tag
        run: |
          TAG=$(cat tag.txt)
          echo "Using tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build and push x86_64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./rust/docker/Dockerfile.app
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: true
          tags: |
            sctg/rust-photoacoustic:latest-amd64
            sctg/rust-photoacoustic:${{ steps.get_tag.outputs.tag }}-amd64

  build_arm64:
    name: Build Application (arm64)
    needs: get_version_tag
    runs-on: ubuntu-latest
    if: (github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run') && !inputs.skip_builds
    steps:
      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@docker-storage
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"

      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up QEMU for arm64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get version tag
        uses: actions/download-artifact@v7
        with:
          name: tag-artifact
      - name: Add TAG to output file
        shell: bash
        id: get_tag
        run: |
          TAG=$(cat tag.txt)
          echo "Using tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build and push arm64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./rust/docker/Dockerfile.app
          platforms: linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: true
          tags: |
            sctg/rust-photoacoustic:latest-arm64
            sctg/rust-photoacoustic:${{ steps.get_tag.outputs.tag }}-arm64

      - name: Save Tag for Next Job
        uses: actions/upload-artifact@v6
        with:
          name: tag-artifact
          path: /tmp/tag.txt

  create_multiarch_manifest:
    name: Create Multi-Architecture Manifest
    needs: [build_amd64, build_arm64, get_version_tag]
    runs-on: ubuntu-latest
    if: always() && (success('build_amd64') || success('build_arm64') || inputs.skip_builds)
    steps:
      - name: Download Tag from Previous Job
        uses: actions/download-artifact@v7
        with:
          name: tag-artifact
      - name: Add TAG to output file
        shell: bash
        id: get_tag
        run: |
          TAG=$(cat tag.txt)
          echo "Using tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@docker-storage
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"
      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Create and push multiarch image
        continue-on-error: true
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}

          # retrieve arm64 image and extract binaries
          docker pull --platform linux/arm64 sctg/rust-photoacoustic:${TAG}-arm64
          # extract arm64 binaries
          docker create --platform linux/arm64 --name temp-container-arm64 sctg/rust-photoacoustic:${TAG}-arm64
          mkdir -p /tmp/arm64-binaries/usr/local/bin /tmp/arm64-binaries/usr/local/lib
          for binary in create_token analyze_spectrum debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen rust_photoacoustic; do
            docker cp temp-container-arm64:/usr/local/bin/$binary /tmp/arm64-binaries/usr/local/bin/ || echo "$binary not found"
          done
          # extract python arm64 binaries and shared libs 
          docker cp temp-container-arm64:/usr/local/lib/python${{ env.PYTHON_SHORT_VERSION }} /tmp/arm64-binaries/usr/local/lib/ || echo "python${{ env.PYTHON_SHORT_VERSION }} lib not found"  
          docker cp temp-container-arm64:/usr/local/bin/python${{ env.PYTHON_SHORT_VERSION }} /tmp/arm64-binaries/usr/local/bin/ || echo "python${{ env.PYTHON_SHORT_VERSION }} binary not found"
          docker rm temp-container-arm64

          # retrieve amd64 image and extract binaries
          docker pull --platform linux/amd64 sctg/rust-photoacoustic:${TAG}-amd64
          # extract amd64 binaries
          docker create --platform linux/amd64 --name temp-container-amd64 sctg/rust-photoacoustic:${TAG}-amd64
          mkdir -p /tmp/amd64-binaries/usr/local/bin /tmp/amd64-binaries/usr/local/lib
          for binary in create_token analyze_spectrum debug_config differential filters modbus_client noise_generator pid_tuner redis_viewer rs256keygen rust_photoacoustic; do
            docker cp temp-container-amd64:/usr/local/bin/$binary /tmp/amd64-binaries/usr/local/bin/ || echo "$binary not found"
          done
          # extract python amd64 binaries and shared libs 
          docker cp temp-container-amd64:/usr/local/lib/python${{ env.PYTHON_SHORT_VERSION }} /tmp/amd64-binaries/usr/local/lib/ || echo "python${{ env.PYTHON_SHORT_VERSION }} lib not found"  
          docker cp temp-container-amd64:/usr/local/bin/python${{ env.PYTHON_SHORT_VERSION }} /tmp/amd64-binaries/usr/local/bin/ || echo "python${{ env.PYTHON_SHORT_VERSION }} binary not found"
          docker rm temp-container-amd64

          # create multiarch image with both architectures' binaries
          CURRENT_DIR=$(pwd)
          cd /tmp
          docker buildx build --platform linux/amd64,linux/arm64 \
            --build-arg PYTHON_VERSION=${{ env.PYTHON_VERSION }} \
            --build-arg PYTHON_SHORT_VERSION=${{ env.PYTHON_SHORT_VERSION }} \
            -f ${CURRENT_DIR}/rust/docker/Dockerfile.multiarch \
            -t sctg/rust-photoacoustic:latest \
            -t sctg/rust-photoacoustic:${TAG} \
            --push .

      - name: Create release packages
        continue-on-error: true
        run: |
          TAG=${{ steps.get_tag.outputs.tag }}
          mkdir -p /tmp/packages
          mkdir -p /tmp/amd64/lib
          # Create amd64 package
          for file in /tmp/amd64-binaries/usr/local/bin/*; do
            cp "$file" /tmp/amd64/
          done
          cp -av /tmp/amd64-binaries/usr/local/lib/python${{ env.PYTHON_SHORT_VERSION }} /tmp/amd64/lib/
          if [ -d "/tmp/amd64" ] && [ "$(ls -A /tmp/amd64)" ]; then
            cd /tmp/amd64
            tar czf /tmp/packages/rust-photoacoustic-${TAG}-x86_64-static-musl-linux-gnu.tar.gz *
            echo "Created amd64 package"
          fi

          # Create arm64 package
          mkdir -p /tmp/arm64/lib
          for file in /tmp/arm64-binaries/usr/local/bin/*; do
            cp "$file" /tmp/arm64/
          done
          cp -av /tmp/arm64-binaries/usr/local/lib/python${{ env.PYTHON_SHORT_VERSION }} /tmp/arm64/lib/
          if [ -d "/tmp/arm64" ] && [ "$(ls -A /tmp/arm64)" ]; then
            cd /tmp/arm64
            tar czf /tmp/packages/rust-photoacoustic-${TAG}-aarch64-static-musl-linux-gnu.tar.gz *
            echo "Created arm64 package"
          fi

      - name: Upload releases package artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-packages
          path: /tmp/packages/

      - name: Upload binaries artifact
        uses: actions/upload-artifact@v6
        with:
          name: final-binaries
          path: /tmp/*-binaries/
