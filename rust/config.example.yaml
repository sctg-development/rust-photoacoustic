# Photoacoustic Water Vapor Analyzer Configuration Example
# --------------------------------------------------------
# This YAML file configures the rust-photoacoustic application.
# YAML is a text based structured file format @see https://en.wikipedia.org/wiki/YAML
# It must pass validation against config.schema.json (see docs for schema details).
# To view the schema, run: `rust-photoacoustic ---show-config-schema`
#
# =========================
# HOW TO GENERATE SECRETS AND CERTIFICATES
# =========================
#
# --- Generate RSA keypair for RS256 JWT signing ---
# POSIX (Linux/macOS):
#   openssl genpkey -algorithm RSA -out private.key -pkeyopt rsa_keygen_bits:2048
#   openssl rsa -pubout -in private.key -out pub.key
#   cat private.key | base64 -w0 > private.key.b64
#   cat pub.key | base64 -w0 > pub.key.b64
# Windows (using Git Bash or WSL):
#   Same as above, or use OpenSSL for Windows (https://slproweb.com/products/Win32OpenSSL.html)
#   Use 'base64 -w0' or 'certutil -encode' (then remove header/footer lines)
#
# --- Generate a PEM certificate for HTTPS (self-signed) ---
# POSIX:
#   openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes -subj "/CN=localhost"
#   base64 -w0 cert.pem > cert.txt
#   base64 -w0 key.pem > key.txt
# Windows:
#   Use OpenSSL for Windows as above, or use PowerShell:
#   New-SelfSignedCertificate -DnsName "localhost" -CertStoreLocation "cert:\LocalMachine\My"
#   # Export as PEM using certmgr or OpenSSL
#
# --- Generate a password hash for a user ---
# POSIX:
#   openssl passwd -5 mypassword | base64 -w0
# Windows:
#   Use Git Bash or WSL for the above, or use Python:
#   python -c "import crypt,base64; print(base64.b64encode(crypt.crypt('mypassword', crypt.mksalt(crypt.METHOD_SHA512)).encode()).decode())"
#
# --- Validate this YAML against the JSON schema ---
# 1. Convert YAML to JSON (e.g. https://www.json2yaml.com/ or https://yaml-online-parser.appspot.com/)
# 2. Use an online JSON schema validator (e.g. https://www.jsonschemavalidator.net/)
#    - Upload your converted JSON
#    - Upload config.schema.json from the repository
#    - Validate and check for errors
#
# =========================
# Visualization server settings
# =========================
visualization:
  # TCP port for the web server (default: 8080)
  port: 8080
  # IP address to bind the server (use 0.0.0.0 or ::0 for all interfaces)
  address: "::0"
  # Server name/version string (for HTTP headers and logs)
  name: LaserSmartApiServer/0.1.0

  # Secret key for signing session cookies (keep this private!)
  # Generate securely: `openssl rand -base64 32`
  session_secret: 6wcVSUhxt1+YPEondChFXtesCL1boh57gqHv2gnEH7U=

  # SSL certificate and key (Base64-encoded PEM, optional for HTTPS)
  # To enable HTTPS, provide both cert and key fields below.
  # Generate and encode with:
  #   cat rust-photoacoustic.local.pem | base64 -w0 > cert.txt
  #   cat rust-photoacoustic.local.key | base64 -w0 > key.txt
  cert: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJmRENDQVNPZ0F3SUJBZ0lVTkdJT2hsWStuTGk2Zld4UDFTcWU1eVZ4S0Ywd0NnWUlLb1pJemowRUF3SXcKRmpFVU1CSUdBMVVFQXd3TFpYaGhiWEJzWlM1amIyMHdIaGNOTWpVd05qSXhNVFF4TURRNVdoY05Nall3TmpJeApNVFF4TURRNVdqQVdNUlF3RWdZRFZRUUREQXRsZUdGdGNHeGxMbU52YlRCWk1CTUdCeXFHU000OUFnRUdDQ3FHClNNNDlBd0VIQTBJQUJPODN5akVBcmtNVUgrV3FuTUpCSngvcVNWK2FuQTRUSTRQdzJlYWhYQUJ2dVMya2NxUzAKU1l6QjMya1JWSDBkdXR3WStwL0QxSUNURkdHcjgvRW5jbzJqVHpCTk1Eb0dBMVVkRVFRek1ER0NDMlY0WVcxdwpiR1V1WTI5dGdndGxlR0Z0Y0d4bExtTnZiWUlQZDNkM0xtVjRZVzF3YkdVdVkyOXRod1RBcUFFQk1BOEdBMVVkCkR3RUIvd1FGQXdNSG9BQXdDZ1lJS29aSXpqMEVBd0lEUndBd1JBSWdlMmYyUjgwT1BVMjNoc0FieFhabVJiaTQKVklaeXdmbzBKVzNQUTJENndrTUNJRktmT0JTR3hFc2JrK1pXZlcwSlU2OHRmSGh1eGhvY3BabS80MnViYkdlVwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JR0hBZ0VBTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEJHMHdhd0lCQVFRZ3M5V3Y0UjdRYXY5ZTFVZkQKbnJINUhMR3JvemFDdzRzOXRNbmw2THNJbWptaFJBTkNBQVR2TjhveEFLNURGQi9scXB6Q1FTY2Y2a2xmbXB3TwpFeU9EOE5ubW9Wd0FiN2t0cEhLa3RFbU13ZDlwRVZSOUhicmNHUHFmdzlTQWt4UmhxL1B4SjNLTgotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg==

  # JWT authentication secrets:
  # HMAC secret for HS256 JWT signing (used for API authentication)
  hmac_secret: my-super-secret-jwt-key-for-photoacoustic-app

  # RSA keys for RS256 JWT signing (Base64-encoded PEM, used for API authentication)
  # Generate with the `rs256keygen` utility or OpenSSL.
  # These are optional unless you want RS256 support.
  rs256_private_key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS2dJQkFBS0NBZ0VBMVpHelhZOVo4aHJCcUN2NmtlRktHQ2RpSCtRano3L2J4TEFneHl0MmYxREtQcElNCnRsZnFhQmIxWFV1TnZadlFJRWdPUEdwN1ZoU1psYmlEOElzam53STJCR3M5Wk1sUzRMZHFJdU50OG53cnh5Q2MKN1QveWtuVDhlVnlkaXdOZlZJekdva0Q4OExvbEtnT3NCUm5qY1dlY0gwRHl4ZmV2dGIxSWdOMzZrOElRVGMwYgpla0hhMGJjeHhhWjNBaE9UeHJIcE96MmJLaHNQbDVBbkc3MFNlODZuRThtV0dRTEx3SnBJR2J1cXhnemE2VzZ3Cm4ycFVOWnNUNlhKb3NFdGZwMnlZRlFFUFdJSmt5a0FPY3MrcXpxSm9uMGxIc3htQ3pYS290bUtPT05IWmZsaysKZStzSTlhUldFT3ErQW9ZcEZlUVBteWdaLzBsMkR2MkxscXJKWWZXTTBJTEFnZFk5eGZrMmVTTnA2TDJnNzhCWgpqRWZ0ODV1aTlTb3VzNzAvQjBkL2U4S3BOU1ppT25LWTJ4bk1kQ2VoazZZaC9KbFA3bmIra1FMV2xlbm9pYlJmClJBMUJ3cng2SU9BR280Zis1M2JPL1RrSTJxdHB0TFpIcUZzNTJqLy91ZzNVaFc1dXVlbkVlSzRuTVBNTEhkekcKR0lTZUliVE5ia1dVY0o1NnhLcTFzTnZiWXdHdTROYzB5T1dhOExLNmdxdEhkcm1INlF6M3dGdHVaYzVxaER5SAo1eUVpTk5takZpNWZCY015TUZpanhYd1cvcnJkWDNiMFllK1ROMjQ5a2loajJXT2MzNnJML0NHWDNsNXhXR01ECk1UVW0wcGk3VDhETkU2dTMxaDkrQjJ4VVJVZlZkT093Rkk1WUM0QkYwWVNGOXVtMUJUc1BvNXNQTmVrQ0F3RUEKQVFLQ0FnQkI3WXRvTzJOeHlHNjF3blhFYUw2ZHZES2ZVNmIyYit5Z3lCb21RYlYvMGVuTTdQcjlveUFhWjlQdwpxKzBpZGlJR2hSZlg4S3NJUksyd3VWZ0pmbnBOa0xvcUhRekR1eDVaZm1WR1JkemYrUkx1a3BPKzdYbXRXbTNCCjdTUTVFSjV5RkU4Uk1XeWp4MkxIbUlDV3hvb2VyUFJWOVkrOEt4elR4bzNHTWtBek1yb2p1a2hjTWs0aFpTTDUKTjgwUEdBb0xVVXFGWGh3eklFMXM1VFFkYlAxeXVMVjg5MExkajY1a1Uzd2tiWGxuVC9xWUN2SjlFNjdSS1lFNQpGSGRhekxuSGprOVlWSTV2TFRsOThjNUVCUFZlZW1ZL25iaURna0dOdUhKNmN1d2lnQzFhd3FQMlR2VGlGNHYyCkJ2RUhDSEZRYjZtZHBRQjVmU3p6cmJOVW5INHpyY3F3b0NmSlVoWlo4dEVkYnZnRXU2anRGMVJTV1BOT2RJaEsKQjIrOHlOWWNRSDFoa0JZMjdTdnhUdldQKzlBQVVrVmRBcFhyUXdGZDN6dEYwbnNmVmJFM0hrZVJ0ZjNKNmRTaApXTFNIYUVvNlpsYzNuQ0hmMVFYQUxmT3ZzRVJEeHN0UU5NVS9QUmNwZDk0RDhJK2FaQmY2U0RweGswZ0FrNGRxCkQ4VlZjVkdPYXBKK3dVOEFwSndUcmlBcFlaMXU3ZHZmMVFVNE9EN2wrTXhHai9Od2lWTHBhWjlXQ1NxMFNlRlYKbkQ1bWc2L1UyZ3JUeGxRS1ZidGs0eUtmOXRxZm9TdHJsWmNOenI5QzludkRKdFNVWkF1WkJibFN4bDNTblhpdwpTQzFQT0c3YW5pTmdCU1VzK1lQTGhGeXdJa0JQZXdvMmg1eGZjTWNDeXFQZElNdk9NUUtDQVFFQTRXbURMK3ZDCjQrTjhYclBXdXF4eUJ3Zks2NjVvOTlMNGZNS1k0ZyswOVZTNGpsM09XTFJ5c1FkbXQzZE94ZENnUkNmQ1Nkbk0KNmlDNFdlQkxQVGRXK2pPaVdzWFViamRJeGNjL1pOejIyaXhWVkxLS29TT3FHNUhXUTViNmtuVlc0RlhTb0ozbQp0aWxna0NyWXFPR2hDMXJab1NpYlpXeDR6MFgzRkMrUFIxNXQ2WTNLZzZFZHpPQmJJK0JvZU5lT0JYRWt6TUFSCkJJUkNFWHBGc0xVREgzMEErTk9XTThwaFhPTWtVSmpmNEl4VGpMaEFCWjR6bHllaUEveHc3MklqZTV1d2RUbm0KQW1jdWVjWlFxcyt3MWhoRjkvWnFaUnhTQ2JDZDBpMmxaU1hlS3U4OU9PeXZ0NlR5V3BwMUo0TVFKRGJWMTFPYwp0Q3dHRWU1a085aVVkUUtDQVFFQThvekhmRnNTdDMyN0FWV3NFQjZWOWE2Vko5ekIvUno1b1Nhb2ZKWStCNzRiClE5a0JkRyt4Q3JXMnJkSWlJZGx1em1MSXhPZW02T3A5YVIyTTgvWU50eGxhTStVVXNqNCttTHl2Yms3YzNmeloKN0lvaHZsVGZmVy9xUHNLdFdzZnQzaU5FWGptNFZ1NnplR2YyRHprekxuVDBCSHhnU1liRmRsY0U2ZWhRSkVyNAp2MWowWVZkcHFydENhdHp1T2dsS2hGcVhyR0dMN2JCNXpLRThBSTRnNHVRM0s0MGs1ZVNybTQzVVQrL1ljVlFNCmJWL2dNNWsrQTVYUnRyK3JJZjdQaXkrL1BranNHelV3amtKWmYxMVo3Vk5tOUZiOE1NV3FYUVJyL3ZvS09aWWUKVHlqUGU4ZzdtU242Nk5pZjlZL09nb3J5RmxBOWVHZXZRWXNqVEI2ZEpRS0NBUUVBaEpJWnBjVnpDYlJ4SVFHRAorS1lUS2k5YkdPR3F1cFpKcnBhRWMrL283YUMyS29UaEp5cDVpY1JnbE9hR1hiRWxrUEFSUkgza0ZvN0gzWlFjCnJCUXdBMWI2MVlna04rNHJ6cVl3a3BHaVhRNVY0VXBnWGdVcnRxcys2T0dTM1RCRnVBckJwZFU0SzBxS2tEK2kKelRCbUZ0ZUh4MUNxbEN3SG9WLzB3TnAzMmZHZmt3emhYaWtUN2JyRjM0UEw3Y1pZc0xxcWVnRThBUHdJSDE5YQpQV000UXZ5eDVhWUxZTXBXR05zK01HaTR3c2ZGRzY0QmVVeGg2elJVQlNRakI2Y2dWMEpwdFlnbnpxSUFvMzRQClUyWnpDbmVjTHdtdDZXbU9sa1JaalpOckF1SVNtQTI4WkE1UUNpSG9wNERRQmp6KzhVMk8xdVZGOUhFdjRMdmsKRjQ1NVFRS0NBUUVBNXgwcnJCdmZyc1g0SGVKemJIeW9hWXlzQldxOTBaLzlZUWZEL2NydldsTlVDWWRLY3BkRwp2Q3kvMzhyZHlTRTFDeVZucHZBUXc5bEVISmdTeWhlSHBCTmROeHV1WjlVVnNsWUFWM3gveW1wM2dJTnllYmpICnArK3U1WlI4dUliTzZoN3lzMUlPaTQ4eHBhWngrTG1KUWxnZ2QvSEhrZWdBV2EyN09lS3FFcHI1Z09LVElmbTMKN3Y0MTREdWFKK1RZZzFzTE1TOVZ0T3UyY3p5alB1Z3UvK056aW1VWVpwSkl6cFVMWEF2dlVyVkNqaW1RS2JwNApNOVJiR3VaeGU1Z2dUTUQzV3JNRGZ6MWtnZmxJN0NxWVdLSmk5S201N2dNN1BSek1odzNjRmxrcmtrUVJ5Q0hZCllDNTNMYzNVUlpsOHJqa1ZTaHUxSnZpdEx5Z1VQeURnblFLQ0FRRUFzb1I3RGx6aWI1d2JheEZUaC9pR1JXN08KNlFWelJiem5sVmo4VU40TU5wQUdaQ3BOSjZCQksyalViN1AzZEhQR1Vld3hGODh1ZlQwbG5rcDdReElDU2ZZNQpYQWNPeCtaV1NQWWpCOGpKMkh4N2lqd3dxK2F1UGgvelpQWnBoK0NpR2Q1Tmc1dnNCU2tyOGRxV1Q1VU9pRVVpClFtMUFSUldvMEJEQnM3bHgrVVRLRy9zRjdMMG1seTJyTzhlMUR6S2JEVzNzNFNqdUFGdWhqSjhLZnR0R2RvaU0KeS9EU2dHT2U4aDl6WEZWbTUwV1JwdkR4bnQyYlVBbHl4cTF2cjFuNnRQTWl1SFBMbWZaVHJZT2pTb3g2YVk4SwpBUTZKNm42RXl4YU9ydCtVeTd0ZFJiWWV5WDF4bHAwSzN3SmpMM3BqM01qU2NlMElzVGloT3F2ZVlrT0Rrdz09Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
  rs256_public_key: LS0tLS1CRUdJTiBSU0EgUFVCTElDIEtFWS0tLS0tCk1JSUNDZ0tDQWdFQTFaR3pYWTlaOGhyQnFDdjZrZUZLR0NkaUgrUWp6Ny9ieExBZ3h5dDJmMURLUHBJTXRsZnEKYUJiMVhVdU52WnZRSUVnT1BHcDdWaFNabGJpRDhJc2pud0kyQkdzOVpNbFM0TGRxSXVOdDhud3J4eUNjN1QveQprblQ4ZVZ5ZGl3TmZWSXpHb2tEODhMb2xLZ09zQlJuamNXZWNIMER5eGZldnRiMUlnTjM2azhJUVRjMGJla0hhCjBiY3h4YVozQWhPVHhySHBPejJiS2hzUGw1QW5HNzBTZTg2bkU4bVdHUUxMd0pwSUdidXF4Z3phNlc2d24ycFUKTlpzVDZYSm9zRXRmcDJ5WUZRRVBXSUpreWtBT2NzK3F6cUpvbjBsSHN4bUN6WEtvdG1LT09OSFpmbGsrZStzSQo5YVJXRU9xK0FvWXBGZVFQbXlnWi8wbDJEdjJMbHFySllmV00wSUxBZ2RZOXhmazJlU05wNkwyZzc4QlpqRWZ0Cjg1dWk5U291czcwL0IwZC9lOEtwTlNaaU9uS1kyeG5NZENlaGs2WWgvSmxQN25iK2tRTFdsZW5vaWJSZlJBMUIKd3J4NklPQUdvNGYrNTNiTy9Ua0kycXRwdExaSHFGczUyai8vdWczVWhXNXV1ZW5FZUs0bk1QTUxIZHpHR0lTZQpJYlROYmtXVWNKNTZ4S3Exc052Yll3R3U0TmMweU9XYThMSzZncXRIZHJtSDZRejN3RnR1WmM1cWhEeUg1eUVpCk5ObWpGaTVmQmNNeU1GaWp4WHdXL3JyZFgzYjBZZStUTjI0OWtpaGoyV09jMzZyTC9DR1gzbDV4V0dNRE1UVW0KMHBpN1Q4RE5FNnUzMWg5K0IyeFVSVWZWZE9Pd0ZJNVlDNEJGMFlTRjl1bTFCVHNQbzVzUE5la0NBd0VBQVE9PQotLS0tLUVORCBSU0EgUFVCTElDIEtFWS0tLS0tCg==

  # Compression
  # Enable or disable compression at the rocket server level.
  # This is useful for reducing bandwidth usage, especially for large data transfers.
  compression: true
  
# =========================
# Modbus TCP server settings
# =========================
modbus:
  # TCP port for Modbus server
  port: 1502
  # IP address to bind Modbus server
  address: "127.0.0.1"
  # Enable or disable Modbus server
  enabled: false

# =========================
# Photoacoustic acquisition settings
# =========================
photoacoustic:
  # Input source: specify either input_device (e.g. alsa:0) or input_file (wav file)
  #input_device: alsa:0
  input_file: input.wav

  # Excitation frequency in Hz for the laser
  frequency: 2000.0

  # Bandwidth of the band-pass filter (Hz)
  bandwidth: 100.0

  # Analyzer window size (samples)
  # The length is seconds of this window can be calculated as:
  #   frame_size / sampling_rate
  # For example, with a frame_size of 4096 and sampling_rate of 44100:
  #   4096 / 44100 = 0.0929 seconds (approximately 93 ms)
  frame_size: 4096

  # Sampling rate in Hz
  sampling_rate: 44100

  # Number of spectra to average for noise reduction
  averages: 10

  # Simulated photoacoustic source configuration
  # When present, enables simulation mode with comprehensive physics modeling
  # Comment out or set to null to use real hardware sources
  simulated_source:
    # Source type: 'mock' for simple MockSource or 'universal' for full physics simulation
    # - mock: Lightweight simulation with correlation-based signal generation
    # - universal: Complete physics simulation with Helmholtz resonance, gas flow, thermal drift
    # source_type: "mock"
    
    # # Inter-channel correlation coefficient [-1.0, 1.0] for dual-microphone configuration
    # # Used by 'mock' source type for simple correlation-based generation
    # correlation: 0.8
    
    # # Background noise amplitude [0.0, 1.0] - thermal and electronic noise
    # background_noise_amplitude: 0.1
    
    # # Helmholtz resonance frequency [Hz] - cell acoustic resonance
    # resonance_frequency: 2100.0
    
    # # Laser modulation depth [0.0, 1.0] - photoacoustic signal strength
    # laser_modulation_depth: 0.8
    
    # # Base photoacoustic signal amplitude [0.0, 1.0]
    # signal_amplitude: 0.5
    
    # # Phase opposition between microphones [degrees] - differential configuration
    # phase_opposition_degrees: 180.0
    
    # # Temperature drift effect factor [0.0, 0.1] - thermal stability
    # temperature_drift_factor: 0.01
    
    # # Gas flow noise factor [0.0, 1.0] - turbulent flow effects
    # gas_flow_noise_factor: 0.05
    
    # # Signal-to-noise ratio factor [0.1, 100.0] - measurement quality
    # snr_factor: 10.0
    
    # # Laser modulation mode: 'amplitude' (continuous) or 'pulsed' (discrete)
    # modulation_mode: "amplitude"
    
    # # Pulse width [seconds] - for pulsed modulation mode
    # pulse_width_seconds: 0.05
    
    # # Pulse frequency [Hz] - for pulsed modulation mode
    # pulse_frequency_hz: 20.0

  # Alternative: Universal physics simulation configuration
  # Uncomment and modify the source_type to "universal" to use comprehensive physics modeling
  # simulated_source:
    source_type: "universal"
    correlation: 0.8
    background_noise_amplitude: 0.1
    resonance_frequency: 2100.0
    laser_modulation_depth: 0.9
    signal_amplitude: 0.7
    phase_opposition_degrees: 175.0
    temperature_drift_factor: 0.02
    gas_flow_noise_factor: 0.3
    snr_factor: 25.0
    modulation_mode: "amplitude"
    pulse_width_seconds: 0.005
    pulse_frequency_hz: 100.0

  # Record consumer settings
  # If enabled, the stream data will be consumed by the record consumer
  record_consumer: false
  record_file: "recording.wav"

# =========================
# Access control and user management
# =========================
access:
  iss: LaserSmartServer # Issuer for JWT tokens
  duration: 86400 # Optional duration in seconds of the issued tokens minimum 3600, maximum 31536000
  users:
    # List of users with hashed passwords and permissions
    # Passwords are hashed (e.g. with openssl passwd -5) and base64-encoded
    - user: administrator
      pass: JDUkcVc2NUtlSTVwb2ZRMC5VTCRmTnl2Vjh4MTJQMnBvcXlGa2htUnNRRWhLRFV3LzIuUVpseDc1UEFxeWdECg== # password: 'password'
      permissions:
        - "read:api"
        - "write:api"
        - "admin:api"
      # Optional user metadata
      email: administrator@example.org
      name: Administrator User
    # - user: reader
    #   pass: JDUkRmp3NUJRLlM1alZkOXVkciRma0E3eG9PYnhiL1Uxam1UeU05VjhzcDVPb1F3VzBSN1gzRW9pMjN0ZVVBCg== # password: '123445678'
    #   permissions:
    #     - "read:api"
    #   email: reader@example.org
  clients:
  # OAuth2/OpenID Connect clients allowed to use the API
    - client_id: LaserSmartClient
      default_scope: "openid profile email"
      allowed_callbacks:
        - "https://localhost:8080/client/"
        - "http://localhost:8080/client/"
        - "https://127.0.0.1:8080/client/"
        - "http://127.0.0.1:8080/client/"

# =========================
# OAuth2/OpenID Connect client configuration (for web client)
# =========================
generix:
  issuer: LaserSmartServer # Issuer for the OAuth2/OpenID Connect server, must match the access.iss value
  provider: generix # Only 'generix' is supported
  api_base_url: https://localhost:8080/api # Base URL of the API server
  authority: https://localhost:8080 # Authority URL for OAuth2/OpenID Connect
  client_id: LaserSmartClient # OAuth2/OpenID Connect client ID
  scope: openid email profile read:api write:api # Scopes requested by the client
  redirect_uri: https://localhost:8080/client/ # Redirect URI after authentication
  audience: LaserSmartClient # Audience claim in JWT tokens
  token_issuer: https://localhost:8080 # Token issuer base URL
  jwks_endpoint: https://localhost:8080/.well-known/jwks.json # JWKS endpoint for public keys
  domain: localhost # Domain for the client application

# =========================
# Signal processing configuration
# =========================
processing:
  enabled: true
  result_buffer_size: 1000
  default_graph:
    id: default
    nodes:
    - id: input
      node_type: input
      parameters: null
    # Record original audio
    - id: "original_recorder"
      node_type: "record"
      parameters:
        record_file: "./recordings/original.wav"
        max_size: 1024
        auto_delete: false
        total_limit: 5120  # Maximum 5MB total for all recordings
    
    # Apply differential processing
    - id: "differential_detection"
      node_type: "channel_mixer"
      parameters:
        strategy: add # Use 'add' for differential detection (adding the two channels at 180 degrees phase opposition)

    - id: "streaming_post_differential"
      node_type: "streaming"
      parameters: null
    
    - id: bandpass_filter
      node_type: filter
      parameters:
        type: bandpass
        center_frequency: 2000.0  # Center at 2 kHz
        bandwidth: 200.0          # 200 Hz bandwidth (1900-2100 Hz passband)
        order: 2                  # optional order second-order (-12dB/octave)  (must be even)
                                  # for first-order use a combination of lowpass and highpass filters

    # Peak finder for real-time frequency analysis (pass-through)
    # Note: fft_size uses photoacoustic.frame_size and sample_rate uses photoacoustic.sample_rate
    - id: "peak_detector"
      node_type: "computing_peak_finder"
      parameters:
        detection_threshold: 0.1      # 10% amplitude threshold
        frequency_min: 1800.0         # Lower bound (Hz)
        frequency_max: 2200.0         # Upper bound (Hz)
        smoothing_factor: 0.7        # Moving average smoothing

    # Concentration calculation based on peak detection
    # This node calculates the concentration based on the detected peak frequency
    - id: "concentration_calculator"
      node_type: "computing_concentration"
      parameters:
        computing_peak_finder_id: "peak_detector"  # Reference to the peak detector node
        polynomial_coefficients:  # Polynomial coefficients for concentration calculation 
          # Array of 5 coefficients [a₀, a₁, a₂, a₃, a₄]
          # Polynomial coefficients for concentration calculation a₀, a₁, a₂, a₃, a₄ 
          # Concentration(ppm) = a₀ + a₁A + a₂A² + a₃A³ + a₄A⁴ where A is the peak amplitude
          - 0.0           # a₀ constant term
          - 0.5892        # a₁ linear term
          - -0.003        # a₂ quadratic term
          - 0.000001      # a₃ cubic term
          - 0.000000001   # a₄ quartic term
        temperature_compensation: false  # Controle temperature compensation
        spectral_line_id: CO₂_4.26μm  # Optional line identifier for concentration calculation
        min_amplitude_threshold: 0.001 # Minimum amplitude threshold for valid concentration calculation
        max_concentration_ppm: 100.0  # Maximum concentration limit for safety/validation

    # Apply gain adjustment (+3 dB amplification)
    - id: "gain_amplifier"
      node_type: "gain"
      parameters:
        gain_db: 3.0  # +3 dB gain (approximately 1.41x amplification)

    - id: "streaming_bandpass_filter"
      node_type: "streaming"
      parameters: null

    # Record processed audio
    - id: "processed_recorder"
      node_type: "record"
      parameters:
        record_file: "./recordings/processed.wav"
        max_size: 1024
        auto_delete: false
        total_limit: 10240  # Maximum 10MB total for all recordings

    # Graph connections
    connections:
    - from: input
      to: original_recorder
    - from: original_recorder
      to: differential_detection
    - from: differential_detection
      to: streaming_post_differential
    - from: streaming_post_differential
      to: bandpass_filter
    - from: bandpass_filter
      to: peak_detector
    - from: peak_detector
      to: concentration_calculator
    - from: concentration_calculator
      to: streaming_bandpass_filter
    - from: streaming_bandpass_filter
      to: processed_recorder
    - from: streaming_bandpass_filter
      to: gain_amplifier
    - from: gain_amplifier
      to: processed_recorder
      
  performance:
    max_processing_time_us: 10000
    enable_stats: true
    stats_interval_ms: 1000

# =========================
# Thermal regulation configuration
# =========================
thermal_regulation:
  # Enable thermal regulation system
  enabled: false
  
  # I2C bus configurations
  i2c_buses:
    # Physical hardware bus (Raspberry Pi native I2C)
    primary:
      type: "native"  # "native", "cp2112", or "mock"
      device: "/dev/i2c-1"
      # For CP2112:
      # usb_vendor_id: 0x10C4
      # usb_product_id: 0xEA90
      
      # PWM controllers (up to 32)
      pwm_controllers:
        - address: 0x40  # PCA9685 #1
          channels: 16
          frequency_hz: 1000
        - address: 0x41  # PCA9685 #2
          channels: 16
          frequency_hz: 1000
        # ... up to 0x5F for 32 controllers
      
      # ADC converters (up to 4)
      adc_controllers:
        - address: 0x48  # ADS1115 #1
          channels: 4
          resolution: 16
          voltage_ref: 3.3
          gain: "GAIN_TWO"
        - address: 0x49  # ADS1115 #2
          channels: 4
          resolution: 16
          voltage_ref: 3.3
          gain: "GAIN_TWO"
        - address: 0x4A  # ADS1115 #3
          channels: 4
          resolution: 16
          voltage_ref: 3.3
          gain: "GAIN_TWO"
        - address: 0x4B  # ADS1115 #4
          channels: 4
          resolution: 16
          voltage_ref: 3.3
          gain: "GAIN_TWO"
      
      # I2C GPIO controllers (up to 8)
      gpio_controllers:
        - address: 0x20  # CAT9555 #1
          channels: 16
          type: "CAT9555"
          function: "h_bridge_control"
        - address: 0x21  # CAT9555 #2
          channels: 16
          type: "CAT9555"
          function: "h_bridge_control"
        - address: 0x22  # CAT9555 #3
          channels: 16
          type: "CAT9555"
          function: "h_bridge_control"
        # ... up to 0x27 for 8 controllers
    
    # Mock bus for thermal simulation and testing
    # Use this configuration for development and testing thermal regulation
    # before hardware is available. The mock driver simulates a 1016g stainless
    # steel 316 photoacoustic cell (110x30x60mm) with 15x30mm Peltier module
    # and 10W heating resistor with realistic thermal dynamics.
    mock_thermal:
      type: "mock"
      device: "mock_thermal_cell"  # Identifier for mock device
      
      # Mock PWM controllers for thermal simulation
      pwm_controllers:
        - address: 0x40  # Simulated PCA9685 for thermal control
          channels: 16
          frequency_hz: 1000
      
      # Mock ADC controllers for temperature reading simulation
      adc_controllers:
        - address: 0x48  # Simulated ADS1115 for temperature sensors
          channels: 4
          resolution: 16
          voltage_ref: 3.3
          gain: "GAIN_TWO"
      
      # Mock GPIO controllers for H-Bridge simulation
      gpio_controllers:
        - address: 0x20  # Simulated CAT9555 for H-Bridge control
          channels: 16
          type: "CAT9555"
          function: "h_bridge_control"
    
    # Optional secondary bus
    secondary:
      type: "native"  # /dev/i2c-0 or additional CP2112
      device: "/dev/i2c-0"
      # Similar configuration with 32 additional PCA9685 + 4 ADS1115 + 8 CAT9555

  # Individual regulators configuration
  regulators:
    # Physical hardware regulator example
    - id: "sample_temperature"
      name: "Sample Temperature"
      enabled: true
      
      # I2C resource allocation
      i2c_bus: "primary"
      temperature_sensor:
        adc_address: 0x48    # ADS1115 #1
        adc_channel: 0       # Channel 0
        sensor_type: "generic"
      
      actuators:
        # Bidirectional thermal control configuration
        thermal_control:
          pwm_controller:
            address: 0x40  # PCA9685 #1
            channel: 0     # PWM channel for power
          
          direction_controller:
            address: 0x20  # CAT9555 #1
            gpio_pins:
              h_bridge_in1: 0    # GPIO 0 - Direction bit 1
              h_bridge_in2: 1    # GPIO 1 - Direction bit 2
              h_bridge_enable: 2 # GPIO 2 - Enable H-Bridge
              
          # Operating modes
          thermal_modes:
            heating_tec:
              description: "Heating via Peltier module"
              h_bridge_direction: "forward"  # IN1=HIGH, IN2=LOW
              power_range: "0-80%"
              max_power_percent: 80.0
            cooling_tec:
              description: "Cooling via Peltier module"
              h_bridge_direction: "reverse"  # IN1=LOW, IN2=HIGH
              power_range: "0-100%"
              max_power_percent: 100.0
            heating_resistive:
              description: "Heating via resistive element (automatic diode selection)"
              h_bridge_direction: "forward"  # IN1=HIGH, IN2=LOW
              power_range: "0-100%"
              max_power_percent: 100.0
      
      # ADC to temperature conversion using NTC thermistor (10kΩ, β=3977)
      # Configuration for 10kΩ/10kΩ voltage divider with 5V supply
      temperature_conversion:
        # Mathematical formula to convert ADC voltage to temperature in Kelvin
        # NTC formula: 1/T = 1/T0 + ln(R/R0)/β where R = R_pullup * voltage / (V_supply - voltage)
        # Parameters: R_pullup=10kΩ, R0=10kΩ (resistance at 25°C), β=3977, T0=298.15K, V_supply=5V
        # @see https://docs.rs/evalexpr/latest/evalexpr/index.html#builtin-functions for syntax
        # Note: Use `math::ln` for neperian logarithm in evalexpr
        #       Use `math::log` for base-10 logarithm
        formula: "1.0 / (1.0 / 298.15 + math::ln(10000.0 * voltage / (5.0 - voltage) / 10000.0) / 3977.0)"
        adc_resolution: 16  # bits
        voltage_reference: 5.0  # V (supply voltage for voltage divider)
        conversion_type: "ntc_thermistor"  # NTC thermistor with β formula
      
      # PID parameters
      pid_parameters:
        kp: 2.0      # Proportional
        ki: 0.1      # Integral
        kd: 0.05     # Derivative
        setpoint: 298.15  # K (25°C)
        output_min: -100.0
        output_max: 100.0
        integral_max: 50.0  # Anti-windup
      
      # PWM and sampling configuration
      control_parameters:
        sampling_frequency_hz: 10.0
        pwm_frequency_hz: 1000.0
      
      # Safety limits
      safety_limits:
        min_temperature_k: 273.15  # 0°C
        max_temperature_k: 373.15  # 100°C
        max_heating_duty: 80.0     # %
        max_cooling_duty: 80.0     # %
    
    # Mock thermal regulator for testing and development
    # This regulator uses the mock bus to simulate thermal behavior
    # of a 1016g stainless steel 316 photoacoustic cell with realistic
    # thermal dynamics including Peltier cooling/heating and resistive heating
    - id: "mock_cell_temperature"
      name: "Mock Photoacoustic Cell Temperature"
      enabled: true
      
      # Use the mock thermal bus for simulation
      i2c_bus: "mock_thermal"
      temperature_sensor:
        adc_address: 0x48    # Simulated ADS1115
        adc_channel: 0       # Channel 0
        sensor_type: "generic"
      
      actuators:
        # Simulated bidirectional thermal control
        thermal_control:
          pwm_controller:
            address: 0x40  # Simulated PCA9685
            channel: 0     # PWM channel for thermal control
          
          direction_controller:
            address: 0x20  # Simulated CAT9555
            gpio_pins:
              h_bridge_in1: 0    # GPIO 0 - Direction control
              h_bridge_in2: 1    # GPIO 1 - Direction control  
              h_bridge_enable: 2 # GPIO 2 - Enable control
              
          # Thermal modes for mock cell simulation
          thermal_modes:
            heating_tec:
              description: "Mock Peltier heating (1016g SS316 cell)"
              h_bridge_direction: "forward"
              power_range: "0-80%"
              max_power_percent: 80.0
            cooling_tec:
              description: "Mock Peltier cooling (1016g SS316 cell)"
              h_bridge_direction: "reverse"
              power_range: "0-100%"
              max_power_percent: 100.0
            heating_resistive:
              description: "Mock 10W resistive heating"
              h_bridge_direction: "forward"
              power_range: "0-100%"
              max_power_percent: 100.0
      
      # Temperature conversion for NTC thermistor (10kΩ, β=3977)
      # Mock sensor simulating 10kΩ/10kΩ voltage divider with 5V supply
      temperature_conversion:
        # Mathematical formula to convert ADC voltage to temperature in Kelvin
        # NTC formula: 1/T = 1/T0 + ln(R/R0)/β where R = R_pullup * voltage / (V_supply - voltage)
        # Parameters: R_pullup=10kΩ, R0=10kΩ (resistance at 25°C), β=3977, T0=298.15K, V_supply=5V
        formula: "1.0 / (1.0 / 298.15 + math::ln(10000.0 * voltage / (5.0 - voltage) / 10000.0) / 3977.0)"
        adc_resolution: 16  # bits
        voltage_reference: 5.0  # V (supply voltage for voltage divider)
        conversion_type: "ntc_thermistor"  # NTC thermistor with β formula
      
      # PID parameters tuned for mock thermal cell simulation
      pid_parameters:
        kp: 1.0      # Conservative gains for mock testing
        ki: 0.05     # Integral
        kd: 0.02     # Derivative
        setpoint: 303.15  # K (30°C) - test temperature
        output_min: -100.0
        output_max: 100.0
        integral_max: 30.0  # Anti-windup
      
      # Control parameters for mock simulation
      control_parameters:
        sampling_frequency_hz: 5.0   # Slower for testing
        pwm_frequency_hz: 1000.0
      
      # Safety limits for mock testing
      safety_limits:
        min_temperature_k: 273.15  # 0°C
        max_temperature_k: 353.15  # 80°C
        max_heating_duty: 80.0     # %
        max_cooling_duty: 80.0     # %
    
    - id: "detector_temperature"
      name: "Detector Temperature"
      enabled: true
      i2c_bus: "primary"
      temperature_sensor:
        adc_address: 0x48    # ADS1115 #1
        adc_channel: 1       # Channel 1
        sensor_type: "generic"
      actuators:
        thermal_control:
          pwm_controller:
            address: 0x40  # PCA9685 #1
            channel: 1     # PWM channel 1
          direction_controller:
            address: 0x20  # CAT9555 #1
            gpio_pins:
              h_bridge_in1: 3    # GPIO 3
              h_bridge_in2: 4    # GPIO 4
              h_bridge_enable: 5 # GPIO 5
          thermal_modes:
            heating_tec:
              description: "Detector TEC heating"
              h_bridge_direction: "forward"
              power_range: "0-60%"
              max_power_percent: 60.0
            cooling_tec:
              description: "Detector TEC cooling"
              h_bridge_direction: "reverse"
              power_range: "0-100%"
              max_power_percent: 100.0
            heating_resistive:
              description: "Detector resistive heating"
              h_bridge_direction: "forward"
              power_range: "0-80%"
              max_power_percent: 80.0
      # Temperature conversion for NTC thermistor (10kΩ, β=3977)
      # Detector temperature sensor with 10kΩ/10kΩ voltage divider, 5V supply
      temperature_conversion:
        # Mathematical formula to convert ADC voltage to temperature in Kelvin
        # NTC formula: 1/T = 1/T0 + ln(R/R0)/β where R = R_pullup * voltage / (V_supply - voltage)
        # Parameters: R_pullup=10kΩ, R0=10kΩ (resistance at 25°C), β=3977, T0=298.15K, V_supply=5V
        formula: "1.0 / (1.0 / 298.15 + math::ln(10000.0 * voltage / (5.0 - voltage) / 10000.0) / 3977.0)"
        adc_resolution: 16  # bits
        voltage_reference: 5.0  # V (supply voltage for voltage divider)
        conversion_type: "ntc_thermistor"  # NTC thermistor with β formula
      pid_parameters:
        kp: 1.5
        ki: 0.08
        kd: 0.03
        setpoint: 288.15  # K (15°C)
        output_min: -100.0
        output_max: 100.0
        integral_max: 40.0
      control_parameters:
        sampling_frequency_hz: 10.0
        pwm_frequency_hz: 1000.0
      safety_limits:
        min_temperature_k: 263.15  # -10°C
        max_temperature_k: 323.15  # 50°C
        max_heating_duty: 60.0
        max_cooling_duty: 100.0
    
    # Possibility to add up to N regulators according to available resources
    # With 32 PCA9685 × 16 channels = 512 PWM outputs
    # With 4 ADS1115 × 4 channels = 16 analog inputs
    # With 8 CAT9555 × 16 GPIO = 128 GPIO control signals

  # Global thermal regulation system parameters
  global_settings:
    global_sampling_rate_hz: 10.0
    max_concurrent_regulators: 32
    resource_sharing:
      i2c_arbitration_timeout_ms: 100
      max_operation_queue_size: 100
      priority_scheduling: false
    monitoring:
      enable_performance_monitoring: true
      metrics_interval_s: 1.0
      enable_thermal_history: false
      history_buffer_size: 1000